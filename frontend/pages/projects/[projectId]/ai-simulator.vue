<template>
  <div class="ai-simulator-page">
    <div class="page-header">
      <!--
        Developer Mode Trigger: Click title 10 times rapidly to activate
        This displays the FL Controller ASM (Automated State Machine) status
        for debugging purposes. Not intended for end users.
      -->
      <h1 class="page-title" @click="handleDevModeClick">AI Application Simulator</h1>
      <!-- Ë≠¶ÂëäÊ©´ÂπÖ (Figma 277:986) -->
      <div class="warning-banner">
        <v-icon color="warning" size="20">mdi-alert-circle</v-icon>
        <span>Note: All data is generated by the simulator.</span>
      </div>
      <!-- Developer Mode Panel (hidden unless activated by 10 clicks on title) -->
      <div v-if="showDevMode" class="dev-mode-panel">
        <div class="dev-mode-header">
          <v-icon size="16" class="mr-1">mdi-developer-board</v-icon>
          Developer Mode - FL Controller Status
          <v-btn size="x-small" icon variant="text" @click="showDevMode = false">
            <v-icon size="16">mdi-close</v-icon>
          </v-btn>
        </div>
        <div class="dev-mode-content">
          <div v-if="controllerStatus" class="status-grid">
            <div class="status-item">
              <span class="label">Current State:</span>
              <span :class="['value', controllerStatus.current_state.toLowerCase()]">
                {{ controllerStatus.current_state }}
              </span>
            </div>
            <div class="status-item">
              <span class="label">Is Activate:</span>
              <span :class="['value', controllerStatus.is_activate ? 'active' : 'inactive']">
                {{ controllerStatus.is_activate }}
              </span>
            </div>
            <div class="status-item">
              <span class="label">Is Final:</span>
              <span :class="['value', controllerStatus.is_final ? 'final' : 'not-final']">
                {{ controllerStatus.is_final }}
              </span>
            </div>
          </div>
          <div v-else class="status-loading">
            <v-progress-circular size="20" indeterminate />
            <span>Fetching controller status...</span>
          </div>
          <v-btn size="small" color="primary" variant="outlined" class="mt-2" @click="refreshControllerStatus">
            <v-icon size="16" class="mr-1">mdi-refresh</v-icon>
            Refresh
          </v-btn>
        </div>
      </div>
    </div>

    <div class="page-content">
      <!-- Â∑¶ÂÅ¥Èù¢ÊùøÔºöModel List Êàñ NES ÊéßÂà∂Èù¢Êùø -->
      <div class="left-panel">
        <!-- Model List Ë¶ñÂúñ -->
        <template v-if="!selectedModel">
          <div class="panel-header">Model list</div>
          <div class="model-buttons">
            <v-btn
              v-for="model in modelList"
              :key="model.id"
              color="success"
              variant="elevated"
              class="model-btn"
              @click="selectModel(model.id)"
            >
              {{ model.name }}
            </v-btn>
          </div>
        </template>

        <!-- NES Model ÊéßÂà∂Èù¢Êùø (Figma 277:465, 277:510, 277:1326) -->
        <template v-else-if="selectedModel === 'nes'">
          <div class="panel-header">NES</div>
          <div class="nes-controls">
            <v-select
              v-model="nesModelSelect"
              :items="nesModelOptions"
              label="Model Select"
              density="compact"
              variant="outlined"
              class="model-select"
              hide-details
            />
            <!-- Training Parameters (FL Training API Integration) -->
            <div class="training-params">
              <v-text-field
                v-model.number="trainingEpochs"
                label="Epochs"
                type="number"
                density="compact"
                variant="outlined"
                hide-details
                class="param-input"
                :min="1"
                :max="10000"
                :disabled="trainingStatus === 'running'"
              />
              <v-text-field
                v-model.number="trainingLearningRate"
                label="Learning Rate"
                type="number"
                density="compact"
                variant="outlined"
                hide-details
                class="param-input"
                :step="0.0001"
                :min="0.0001"
                :max="1"
                :disabled="trainingStatus === 'running'"
              />
            </div>
            <!-- FL Task Status Display -->
            <div v-if="flTaskStatus" class="fl-status-badge" :class="flTaskStatus">
              <v-icon size="14" class="mr-1">
                {{ flTaskStatus === 'running' ? 'mdi-loading mdi-spin' : flTaskStatus === 'waiting' ? 'mdi-clock-outline' : 'mdi-check-circle' }}
              </v-icon>
              FL Status: {{ flTaskStatus }}
            </div>
            <!-- Pre-train ÈöéÊÆµÊåâÈàï -->
            <template v-if="!nesPretrainDone">
              <v-btn
                :color="trainingStatus === 'finish' ? 'success' : 'default'"
                :disabled="!nesModelSelect || trainingStatus === 'running'"
                variant="elevated"
                class="control-btn"
                @click="startPreTrain"
              >
                Pre-train
              </v-btn>
              <v-btn
                :color="nesReviewMode ? 'warning' : (trainingStatus === 'finish' ? 'warning' : 'default')"
                :disabled="trainingStatus !== 'finish'"
                variant="elevated"
                class="control-btn"
                @click="showNesReview"
              >
                Review
              </v-btn>
            </template>
            <!-- Finetune ÈöéÊÆµÊåâÈàï (Figma 277:1326) -->
            <template v-else>
              <v-btn
                :color="nesFinetuneStatus !== 'idle' ? 'success' : 'success'"
                :disabled="nesFinetuneStatus === 'running'"
                variant="elevated"
                class="control-btn"
                @click="showNesUploadDialogFn"
              >
                Finetune
              </v-btn>
              <v-btn
                :color="nesEnableMode ? 'warning' : 'default'"
                :disabled="nesFinetuneStatus !== 'finish'"
                variant="elevated"
                class="control-btn"
                @click="enableNesModel"
              >
                Enable
              </v-btn>
              <v-btn
                color="default"
                :disabled="!nesEnableMode"
                variant="elevated"
                class="control-btn"
                @click="startNesRetrain"
              >
                Re-train
              </v-btn>
            </template>
          </div>
          <div class="panel-actions">
            <v-btn color="primary" variant="outlined" class="action-btn" @click="handleNesBack">
              BACK
            </v-btn>
            <!-- Pre-train ÈöéÊÆµÂãï‰ΩúÊåâÈàï -->
            <template v-if="!nesPretrainDone">
              <v-btn
                v-if="trainingStatus === 'running'"
                color="error"
                variant="elevated"
                class="action-btn"
                @click="stopTraining"
              >
                STOP
              </v-btn>
              <v-btn
                v-else-if="trainingStatus === 'finish' && !nesReviewMode"
                color="primary"
                variant="elevated"
                class="action-btn"
                @click="confirmNesPretrainDone"
              >
                Update
              </v-btn>
              <v-btn
                v-else-if="!nesReviewMode && trainingStatus === 'idle'"
                color="primary"
                variant="elevated"
                class="action-btn"
                @click="startTraining"
              >
                START
              </v-btn>
            </template>
            <!-- Finetune ÈöéÊÆµÂãï‰ΩúÊåâÈàï -->
            <template v-else>
              <v-btn
                v-if="nesFinetuneStatus === 'running'"
                color="error"
                variant="elevated"
                class="action-btn"
                @click="stopNesFinetuning"
              >
                STOP
              </v-btn>
              <v-btn
                v-else-if="nesFinetuneStatus === 'finish'"
                color="primary"
                variant="elevated"
                class="action-btn"
                @click="updateNesFinetuneModel"
              >
                Update
              </v-btn>
              <v-btn
                v-else-if="nesFinetuneStatus === 'idle' && !nesEnableMode"
                color="primary"
                variant="elevated"
                class="action-btn"
                @click="showNesUploadDialogFn"
              >
                START
              </v-btn>
            </template>
          </div>
        </template>

        <!-- Positioning Model ÊéßÂà∂Èù¢Êùø (Figma 277:907, 277:993) -->
        <template v-else-if="selectedModel === 'positioning'">
          <div class="panel-header">Positioning</div>
          <div class="positioning-controls">
            <v-select
              v-model="posModelSelect"
              :items="posModelOptions"
              label="Model Select"
              density="compact"
              variant="outlined"
              class="model-select"
              hide-details
            />
            <!-- Pre-train ÊåâÈàïÔºàÂàùÂßãÈöéÊÆµÔºâ -->
            <v-btn
              v-if="!posPretrainDone"
              :color="posModelSelect ? 'success' : 'default'"
              :disabled="!posModelSelect || posTrainingStatus === 'running'"
              variant="elevated"
              class="control-btn"
              @click="startPosPretrain"
            >
              Pre-train
            </v-btn>
            <!-- Finetune ÊåâÈàïÔºàPre-train ÂÆåÊàêÂæåÔºâ -->
            <v-btn
              v-else
              :color="posFinetuneStatus === 'idle' ? 'success' : 'default'"
              :disabled="posFinetuneStatus === 'running'"
              variant="elevated"
              class="control-btn"
              @click="showPosUploadDialogFn"
            >
              Finetune
            </v-btn>
            <!-- Review ÊåâÈàïÔºàPre-train ÂÆåÊàêÂæåÔºåFinetune ÂâçÔºâ -->
            <v-btn
              v-if="!posPretrainDone"
              :color="posTrainingStatus === 'finish' ? 'warning' : 'default'"
              :disabled="posTrainingStatus !== 'finish'"
              variant="elevated"
              class="control-btn"
              @click="showPosReview"
            >
              Review
            </v-btn>
            <!-- Enable ÊåâÈàïÔºàFinetune ÂÆåÊàêÂæåÔºâ -->
            <v-btn
              v-else
              :color="posEnableMode ? 'warning' : 'default'"
              :disabled="posFinetuneStatus !== 'finish'"
              variant="elevated"
              class="control-btn"
              @click="enablePosModel"
            >
              Enable
            </v-btn>
            <!-- Re-train ÊåâÈàïÔºàEnable ÂæåÔºâ -->
            <v-btn
              v-if="posPretrainDone"
              :color="posEnableMode ? 'info' : 'default'"
              :disabled="!posEnableMode"
              variant="elevated"
              class="control-btn"
              @click="startPosRetrain"
            >
              Re-train
            </v-btn>
          </div>
          <div class="panel-actions">
            <v-btn color="primary" variant="outlined" class="action-btn" @click="handlePosBack">
              BACK
            </v-btn>
            <v-btn
              v-if="posTrainingStatus === 'running' || posFinetuneStatus === 'running'"
              color="error"
              variant="elevated"
              class="action-btn"
              @click="stopPosTraining"
            >
              STOP
            </v-btn>
            <v-btn
              v-else-if="posTrainingStatus === 'finish' && !posPretrainDone"
              color="primary"
              variant="elevated"
              class="action-btn"
              @click="confirmPretrainDone"
            >
              Update
            </v-btn>
            <v-btn
              v-else-if="posFinetuneStatus === 'finish'"
              color="primary"
              variant="elevated"
              class="action-btn"
              @click="updatePosModel"
            >
              Update
            </v-btn>
            <v-btn
              v-else-if="!posPretrainDone && posTrainingStatus === 'idle'"
              color="primary"
              variant="elevated"
              class="action-btn"
              @click="startPosTraining"
            >
              START
            </v-btn>
          </div>
        </template>

        <!-- RSM (Radio Slicing Management) Model ÊéßÂà∂Èù¢Êùø -->
        <template v-else-if="selectedModel === 'rsm'">
          <div class="panel-header">RSM</div>
          <div class="rsm-controls">
            <v-select
              v-model="rsmModelSelect"
              :items="rsmModelOptions"
              label="Model Select"
              density="compact"
              variant="outlined"
              class="model-select"
              hide-details
            />
            <!-- Training Parameters -->
            <div class="training-params">
              <v-text-field
                v-model.number="trainingEpochs"
                label="Epochs"
                type="number"
                density="compact"
                variant="outlined"
                hide-details
                class="param-input"
                :min="1"
                :max="10000"
                :disabled="rsmTrainingStatus === 'running'"
              />
              <v-text-field
                v-model.number="trainingLearningRate"
                label="Learning Rate"
                type="number"
                density="compact"
                variant="outlined"
                hide-details
                class="param-input"
                :step="0.0001"
                :min="0.0001"
                :max="1"
                :disabled="rsmTrainingStatus === 'running'"
              />
            </div>
            <!-- FL Task Status Display -->
            <div v-if="flTaskStatus" class="fl-status-badge" :class="flTaskStatus">
              <v-icon size="14" class="mr-1">
                {{ flTaskStatus === 'running' ? 'mdi-loading mdi-spin' : flTaskStatus === 'waiting' ? 'mdi-clock-outline' : 'mdi-check-circle' }}
              </v-icon>
              FL Status: {{ flTaskStatus }}
            </div>
            <!-- Pre-train ÊåâÈàï -->
            <v-btn
              :color="rsmTrainingStatus === 'finish' ? 'success' : 'default'"
              :disabled="!rsmModelSelect || rsmTrainingStatus === 'running'"
              variant="elevated"
              class="control-btn"
              @click="startRsmPretrain"
            >
              Pre-train
            </v-btn>
            <!-- Enable ÊåâÈàï -->
            <v-btn
              :color="rsmEnableMode ? 'warning' : 'default'"
              :disabled="rsmTrainingStatus !== 'finish'"
              variant="elevated"
              class="control-btn"
              @click="enableRsmModel"
            >
              Enable
            </v-btn>
            <!-- Re-train ÊåâÈàï -->
            <v-btn
              color="default"
              :disabled="!rsmEnableMode"
              variant="elevated"
              class="control-btn"
              @click="startRsmRetrain"
            >
              Re-train
            </v-btn>
          </div>
          <div class="panel-actions">
            <v-btn color="primary" variant="outlined" class="action-btn" @click="goBack">
              BACK
            </v-btn>
            <v-btn
              v-if="rsmTrainingStatus === 'running'"
              color="error"
              variant="elevated"
              class="action-btn"
              @click="stopRsmTraining"
            >
              STOP
            </v-btn>
            <v-btn
              v-else-if="rsmTrainingStatus === 'idle'"
              color="primary"
              variant="elevated"
              class="action-btn"
              @click="startRsmTraining"
            >
              START
            </v-btn>
          </div>
        </template>

        <!-- ÂÖ∂‰ªñÊ®°Âûã placeholder -->
        <template v-else>
          <div class="panel-header">{{ selectedModel.toUpperCase() }}</div>
          <div class="placeholder-content">
            <v-icon size="48" color="grey">mdi-cog</v-icon>
            <p class="text-grey">ÂäüËÉΩÈñãÁôº‰∏≠</p>
          </div>
          <div class="panel-actions">
            <v-btn color="primary" variant="outlined" class="action-btn" @click="goBack">
              BACK
            </v-btn>
          </div>
        </template>
      </div>

      <!-- Âè≥ÂÅ¥Èù¢ÊùøÔºöScene Êàñ Pre-Train Process -->
      <div class="right-panel">
        <!-- Scene Ë¶ñÂúñ (ÁÑ°Ë®ìÁ∑¥ÊôÇ) -->
        <template v-if="!isTrainingActive">
          <div class="panel-header">Scene</div>
          <div class="map-container">
            <div id="aiSimulatorMap" class="map-view" />
            <!-- Ëâ≤Ê®ô -->
            <div v-show="showHeatmap" class="color-bar">
              <div class="color-gradient" />
              <div class="color-labels">
                <span>-59.8 dBm</span>
                <span>-140.0 dBm</span>
              </div>
            </div>
            <!-- Heatmap ÊéßÂà∂ -->
            <div class="heatmap-control">
              <v-switch
                v-model="showHeatmap"
                label="Heatmap"
                density="compact"
                hide-details
                class="heatmap-switch"
              />
              <v-select
                v-model="heatmapType"
                :items="['RSRP']"
                density="compact"
                class="heatmap-select"
                hide-details
              />
            </div>
          </div>
        </template>

        <!-- NES Pre-Train Process Ë¶ñÂúñ (Figma 277:383) -->
        <template v-else-if="selectedModel === 'nes' && !nesReviewMode && !nesPretrainDone">
          <div class="panel-header">
            Pre-Train Process
            <span :class="['training-status', trainingStatus]">
              Training Status : {{ trainingStatus }}
            </span>
          </div>
          <div class="training-content">
            <!-- Ë®ìÁ∑¥ÂúñË°®ÂçÄÂüü -->
            <div class="charts-section">
              <!-- ‰∏ªÂúñË°®ÔºöReward over Epochs -->
              <div class="chart-container main-chart">
                <p class="chart-title">Reward over Epochs (with MA10)</p>
                <div class="chart-wrapper">
                  <canvas ref="rewardChartRef" />
                </div>
              </div>
              <!-- Â∫ïÈÉ®ÂÖ©ÂÄãÂ∞èÂúñË°® -->
              <div class="charts-row">
                <div class="chart-container">
                  <p class="chart-title">Critic Loss over Epochs</p>
                  <div class="chart-wrapper small">
                    <canvas ref="criticLossChartRef" />
                  </div>
                </div>
                <div class="chart-container">
                  <p class="chart-title">Actor Loss over Epochs</p>
                  <div class="chart-wrapper small">
                    <canvas ref="actorLossChartRef" />
                  </div>
                </div>
              </div>
            </div>
            <!-- Ë®ìÁ∑¥Ë≥áË®ä -->
            <div class="training-info">
              <p class="info-item highlight">Loss Function : Self-defined</p>
              <p class="info-item">Epoch: {{ trainingEpoch }}/1000</p>
              <div class="results-section">
                <p class="results-title">Training Results:</p>
                <p class="result-item">Reward: {{ trainingResults.reward.toFixed(2) }}</p>
                <p class="result-item">Actor Loss: {{ trainingResults.actorLoss.toFixed(1) }}</p>
                <p class="result-item">Critic Loss: {{ trainingResults.criticLoss.toFixed(3) }}</p>
              </div>
            </div>
          </div>
        </template>

        <!-- NES Review Ë¶ñÂúñ (Figma 277:1286, 277:296) -->
        <template v-else-if="selectedModel === 'nes' && nesReviewMode">
          <div class="panel-header">Review</div>
          <div class="nes-review-content">
            <div class="nes-review-map-container">
              <!-- Â†¥ÊôØÈÅ∏Êìá‰∏ãÊãâÈÅ∏ÂñÆ -->
              <v-select
                v-model="nesSelectedScenario"
                :items="nesScenarioOptions"
                density="compact"
                variant="outlined"
                class="scenario-select"
                hide-details
              />
              <!-- Âú∞Âúñ -->
              <div id="nesReviewMap" class="nes-review-map" />
              <!-- Ëâ≤Ê®ô -->
              <div v-show="showNesHeatmap && nesSelectedScenario !== 'None'" class="color-bar">
                <div class="color-gradient" />
                <div class="color-labels">
                  <span>-55 dBm</span>
                  <span>-140 dBm</span>
                </div>
              </div>
              <!-- Âúñ‰æã -->
              <div v-if="nesSelectedScenario !== 'None'" class="nes-review-legend">
                <div class="legend-item">
                  <span class="legend-icon ue-icon">üë§</span>
                  <span>: UE</span>
                </div>
                <div class="legend-item">
                  <span class="legend-icon wifi-icon">üì∂</span>
                  <span>: gNB</span>
                </div>
              </div>
              <!-- Heatmap ÊéßÂà∂ -->
              <div class="heatmap-control">
                <v-switch
                  v-model="showNesHeatmap"
                  label="Heatmap"
                  density="compact"
                  hide-details
                  class="heatmap-switch"
                />
                <v-select
                  v-model="nesHeatmapType"
                  :items="['RSRP']"
                  density="compact"
                  class="heatmap-select"
                  hide-details
                />
              </div>
            </div>
          </div>
        </template>

        <!-- NES Finetune Training Process Ë¶ñÂúñ (Figma 277:1326, 277:1366) -->
        <template v-else-if="selectedModel === 'nes' && nesPretrainDone && !nesEnableMode && (nesFinetuneStatus === 'running' || nesFinetuneStatus === 'finish')">
          <div class="panel-header">
            Training Process
            <span :class="['training-status', nesFinetuneStatus]">
              Training Status : {{ nesFinetuneStatus === 'finish' ? 'Finish' : 'running' }}
            </span>
          </div>
          <div class="training-content">
            <!-- Ë®ìÁ∑¥ÂúñË°®ÂçÄÂüü -->
            <div class="charts-section">
              <!-- ‰∏ªÂúñË°®ÔºöReward over Epochs -->
              <div class="chart-container main-chart">
                <p class="chart-title">Reward over Epochs (with MA10)</p>
                <div class="chart-wrapper">
                  <canvas ref="nesFinetuneRewardChartRef" />
                </div>
              </div>
              <!-- Â∫ïÈÉ®ÂÖ©ÂÄãÂ∞èÂúñË°® -->
              <div class="charts-row">
                <div class="chart-container">
                  <p class="chart-title">Critic Loss over Epochs</p>
                  <div class="chart-wrapper small">
                    <canvas ref="nesFinetuneCriticLossChartRef" />
                  </div>
                </div>
                <div class="chart-container">
                  <p class="chart-title">Actor Loss over Epochs</p>
                  <div class="chart-wrapper small">
                    <canvas ref="nesFinetuneActorLossChartRef" />
                  </div>
                </div>
              </div>
            </div>
            <!-- Ë®ìÁ∑¥Ë≥áË®ä -->
            <div class="training-info">
              <p class="info-item highlight">Loss Function : Self-defined</p>
              <p class="info-item">Epoch: {{ nesFinetuneEpoch }}/1000</p>
              <div class="results-section">
                <p class="results-title">Training Results:</p>
                <p class="result-item">Reward: {{ nesFinetuneResults.reward.toFixed(2) }}</p>
                <p class="result-item">Actor Loss: {{ nesFinetuneResults.actorLoss.toFixed(1) }}</p>
                <p class="result-item">Critic Loss: {{ nesFinetuneResults.criticLoss.toFixed(3) }}</p>
              </div>
            </div>
          </div>
        </template>

        <!-- NES Enable Project Ë¶ñÂúñ -->
        <template v-else-if="selectedModel === 'nes' && nesPretrainDone && nesEnableMode && !nesDashboardMode">
          <div class="panel-header">Project</div>
          <div class="enable-content">
            <div class="enable-map-container">
              <div id="nesEnableMap" class="enable-map" />
              <!-- Dashboard ÊåâÈàï (Figma 277:1526) -->
              <v-btn
                color="warning"
                variant="flat"
                class="dashboard-btn"
                @click="showNesDashboard"
              >
                Dashboard
              </v-btn>
              <!-- Ëâ≤Ê®ô -->
              <div class="color-bar">
                <div class="color-gradient" />
                <div class="color-labels">
                  <span>-55 dBm</span>
                  <span>-140 dBm</span>
                </div>
              </div>
              <!-- Âúñ‰æã -->
              <div class="enable-legend">
                <div class="legend-item">
                  <span class="legend-icon ue-icon">üë§</span>
                  <span>: UE</span>
                </div>
                <div class="legend-item">
                  <span class="legend-icon wifi-icon">üì∂</span>
                  <span>: gNB</span>
                </div>
              </div>
              <!-- Heatmap ÊéßÂà∂ -->
              <div class="enable-controls">
                <v-switch
                  v-model="showNesHeatmap"
                  label="Heatmap"
                  density="compact"
                  hide-details
                  class="heatmap-switch"
                />
                <v-select
                  v-model="nesHeatmapType"
                  :items="['RSRP']"
                  label="Signal"
                  density="compact"
                  class="signal-select"
                  hide-details
                />
              </div>
            </div>
          </div>
        </template>

        <!-- NES Dashboard Ë¶ñÂúñ (Figma 277:1561) -->
        <template v-else-if="selectedModel === 'nes' && nesPretrainDone && nesEnableMode && nesDashboardMode">
          <div class="panel-header">Project</div>
          <div class="dashboard-content">
            <!-- Map UI ÊåâÈàï -->
            <v-btn
              color="warning"
              variant="flat"
              class="map-ui-btn"
              @click="hideNesDashboard"
            >
              Map UI
            </v-btn>
            <!-- Dashboard Èù¢Êùø -->
            <div class="dashboard-panel">
              <!-- È†ÇÈÉ®Áµ±Ë®àÂç°Áâá -->
              <div class="dashboard-stats">
                <div class="stat-card num-ues">
                  <div class="stat-label">Num of UEs</div>
                  <div class="stat-value">{{ nesDashboardData.numOfUEs }}</div>
                </div>
                <div class="stat-card throughput">
                  <div class="stat-label">DL Throughput</div>
                  <div class="stat-value">{{ nesDashboardData.dlThroughput }} <span class="stat-unit">Mbps</span></div>
                </div>
              </div>
              <!-- ËÉΩËÄóÂÑÄË°® -->
              <div class="dashboard-row">
                <div class="energy-gauge">
                  <div class="gauge-label">Energy Usage</div>
                  <div class="gauge-value">{{ nesDashboardData.energyUsage }} <span class="gauge-unit">W</span></div>
                </div>
                <!-- Radio Power -->
                <div class="radio-power">
                  <div class="power-label">Radio Power</div>
                  <div class="power-bars">
                    <div v-for="(val, idx) in nesDashboardData.radioPower" :key="idx" class="power-bar-item">
                      <div class="power-bar" :style="{ height: val + '%', backgroundColor: val > 0 ? '#4CAF50' : '#ccc' }" />
                      <span class="power-value">{{ val }}</span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- ÂúñË°®ÂçÄÂüü (placeholder) -->
              <div class="dashboard-charts">
                <div class="chart-placeholder">
                  <div class="chart-title">Att</div>
                  <div class="chart-area">ÂúñË°®Ë≥áÊñôÂæÖÂæåÁ´Ø API</div>
                </div>
                <div class="chart-placeholder">
                  <div class="chart-title">Success</div>
                  <div class="chart-area">ÂúñË°®Ë≥áÊñôÂæÖÂæåÁ´Ø API</div>
                </div>
                <div class="chart-placeholder">
                  <div class="chart-title">Energy Efficiency</div>
                  <div class="chart-area">ÂúñË°®Ë≥áÊñôÂæÖÂæåÁ´Ø API</div>
                </div>
                <div class="chart-placeholder">
                  <div class="chart-title">Energy</div>
                  <div class="chart-area">ÂúñË°®Ë≥áÊñôÂæÖÂæåÁ´Ø API</div>
                </div>
              </div>
            </div>
          </div>
        </template>

        <!-- NES Finetune Á©∫ÁôΩÁãÄÊÖãË¶ñÂúñ (Á≠âÂæÖÈñãÂßã) -->
        <template v-else-if="selectedModel === 'nes' && nesPretrainDone && nesFinetuneStatus === 'idle' && !nesEnableMode">
          <div class="panel-header">Project</div>
          <div class="map-container">
            <div id="aiSimulatorMap" class="map-view" />
            <!-- Heatmap ÊéßÂà∂ -->
            <div class="heatmap-control">
              <v-switch
                v-model="showHeatmap"
                label="Heatmap"
                density="compact"
                hide-details
                class="heatmap-switch"
              />
              <v-select
                v-model="heatmapType"
                :items="['RSRP']"
                density="compact"
                class="heatmap-select"
                hide-details
              />
            </div>
          </div>
        </template>

        <!-- Positioning Pre-Train Process Ë¶ñÂúñ (Figma 277:824) -->
        <template v-else-if="selectedModel === 'positioning' && !posPretrainDone && !posReviewMode && !posEnableMode">
          <div class="panel-header">
            Pre-Train Process
            <span :class="['training-status', posTrainingStatus]">
              Training Status : {{ posTrainingStatus }}
            </span>
          </div>
          <div class="training-content">
            <!-- Ë®ìÁ∑¥ÂúñË°®ÂçÄÂüü (ÂñÆ‰∏Ä Loss ÂúñË°®) -->
            <div class="charts-section">
              <div class="chart-container main-chart pos-chart">
                <p class="chart-title">Loss over Epochs</p>
                <div class="chart-wrapper pos-wrapper">
                  <canvas ref="posLossChartRef" />
                </div>
              </div>
            </div>
            <!-- Ë®ìÁ∑¥Ë≥áË®ä -->
            <div class="training-info">
              <p class="info-item highlight">Loss Function : MSE</p>
              <p class="info-item">Epoch: {{ posTrainingEpoch }}/500</p>
              <div class="results-section">
                <p class="results-title">Training Results:</p>
                <p class="result-item">Training Loss: {{ posTrainingResults.trainLoss.toFixed(4) }}</p>
                <p class="result-item">Validation Loss: {{ posTrainingResults.valLoss.toFixed(4) }}</p>
              </div>
            </div>
          </div>
        </template>

        <!-- Positioning Finetune Training Process Ë¶ñÂúñ (Figma 277:993, 277:1032) -->
        <template v-else-if="selectedModel === 'positioning' && posPretrainDone && !posEnableMode && (posFinetuneStatus === 'running' || posFinetuneStatus === 'finish')">
          <div class="panel-header">
            Training Process
            <span :class="['training-status', posFinetuneStatus]">
              Training Status : {{ posFinetuneStatus === 'finish' ? 'Finish' : 'running' }}
            </span>
          </div>
          <div class="training-content">
            <!-- Finetune ÂúñË°® -->
            <div class="charts-section">
              <div class="chart-container main-chart pos-chart">
                <p class="chart-title finetune-title">Loss Function : MSE</p>
                <div class="chart-wrapper pos-wrapper">
                  <canvas ref="posFinetuneChartRef" />
                </div>
              </div>
            </div>
            <!-- Finetune Ë®ìÁ∑¥Ë≥áË®ä -->
            <div class="training-info">
              <p class="info-item">Epoch:</p>
              <p class="info-item large">{{ posFinetuneEpoch }}/500</p>
              <div class="results-section">
                <p class="result-item">Training Loss :</p>
                <p class="result-item large">{{ posFinetuneResults.trainLoss.toFixed(2) }}</p>
                <p class="result-item">Validation Loss :</p>
                <p class="result-item large">{{ posFinetuneResults.valLoss.toFixed(2) }}</p>
              </div>
            </div>
          </div>
        </template>

        <!-- Positioning Enable Project Ë¶ñÂúñ (Figma 277:1190) -->
        <template v-else-if="selectedModel === 'positioning' && posEnableMode">
          <div class="panel-header">Project</div>
          <div class="enable-content">
            <div class="enable-map-container">
              <div id="posEnableMap" class="enable-map" />
              <!-- Ëâ≤Ê®ô -->
              <div class="color-bar">
                <div class="color-gradient" />
                <div class="color-labels">
                  <span>-55 dBm</span>
                  <span>-140 dBm</span>
                </div>
              </div>
              <!-- Âúñ‰æã -->
              <div class="enable-legend">
                <div class="legend-item">
                  <span class="legend-icon ue-icon">üë§</span>
                  <span>: UE</span>
                </div>
                <div class="legend-item">
                  <span class="legend-icon wifi-icon">üì∂</span>
                  <span>: gNB</span>
                </div>
              </div>
              <!-- Heatmap Âíå Signal ÊéßÂà∂ -->
              <div class="enable-controls">
                <v-switch
                  v-model="showEnableHeatmap"
                  label="Heatmap"
                  density="compact"
                  hide-details
                  class="heatmap-switch"
                />
                <v-select
                  v-model="enableSignalType"
                  :items="['RSRP']"
                  label="Signal"
                  density="compact"
                  class="signal-select"
                  hide-details
                />
              </div>
            </div>
          </div>
        </template>

        <!-- Positioning Review Ë¶ñÂúñ (Figma 277:599, 277:652, 277:702) -->
        <template v-else-if="selectedModel === 'positioning' && posReviewMode">
          <div class="panel-header">Review</div>
          <div class="review-content">
            <div class="review-map-container">
              <div id="posReviewMap" class="review-map" />
              <!-- Add Path ÊåâÈàï -->
              <v-btn
                color="info"
                variant="elevated"
                class="add-path-btn"
                @click="addPath"
              >
                Add Path
              </v-btn>
              <!-- UE/Path Âúñ‰æã -->
              <div v-if="posPathData.length > 0" class="path-legend">
                <div class="legend-item">
                  <span class="legend-dot ue" />
                  <span>: UE</span>
                </div>
                <div class="legend-item">
                  <span class="legend-arrow">‚Üó</span>
                  <span>: Path</span>
                </div>
              </div>
              <!-- Ëâ≤Ê®ô -->
              <div v-show="showReviewHeatmap" class="color-bar">
                <div class="color-gradient" />
                <div class="color-labels">
                  <span>-59.8 dBm</span>
                  <span>-140.0 dBm</span>
                </div>
              </div>
              <!-- Heatmap ÊéßÂà∂ -->
              <div class="heatmap-control">
                <v-switch
                  v-model="showReviewHeatmap"
                  label="Heatmap"
                  density="compact"
                  hide-details
                  class="heatmap-switch"
                />
                <v-select
                  v-model="reviewHeatmapType"
                  :items="['RSRP']"
                  density="compact"
                  class="heatmap-select"
                  hide-details
                />
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- NES Upload Finetuning Dataset Â∞çË©±Ê°Ü (Figma 277:1405) -->
    <v-dialog v-model="showNesUploadDialog" max-width="400" persistent>
      <v-card class="upload-dialog">
        <v-card-title class="upload-dialog-title">
          Upload finetuning dataset
        </v-card-title>
        <v-card-text>
          <v-select
            v-model="nesUploadDataset"
            :items="nesDatasetOptions"
            density="compact"
            variant="outlined"
            placeholder="Select dataset"
            hide-details
            class="dataset-select"
          />
        </v-card-text>
        <v-card-actions class="upload-dialog-actions">
          <v-btn
            variant="outlined"
            color="default"
            class="dialog-btn"
            @click="submitNesUpload"
          >
            submit
          </v-btn>
          <v-btn
            variant="outlined"
            color="default"
            class="dialog-btn"
            @click="cancelNesUpload"
          >
            cancel
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- Positioning Upload Finetuning Dataset Â∞çË©±Ê°Ü (Figma 277:1070) -->
    <v-dialog v-model="showPosUploadDialog" max-width="400" persistent>
      <v-card class="upload-dialog">
        <v-card-title class="upload-dialog-title">
          Upload finetuning dataset
        </v-card-title>
        <v-card-text>
          <v-select
            v-model="posUploadDataset"
            :items="posDatasetOptions"
            density="compact"
            variant="outlined"
            placeholder="Select dataset"
            hide-details
            class="dataset-select"
          />
        </v-card-text>
        <v-card-actions class="upload-dialog-actions">
          <v-btn
            variant="outlined"
            color="default"
            class="dialog-btn"
            @click="submitPosUpload"
          >
            submit
          </v-btn>
          <v-btn
            variant="outlined"
            color="default"
            class="dialog-btn"
            @click="cancelPosUpload"
          >
            cancel
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- Go Back Confirmation Dialog -->
    <v-dialog v-model="showBackConfirmDialog" max-width="400" persistent>
      <v-card>
        <v-card-title>Á¢∫Ë™çËøîÂõû</v-card-title>
        <v-card-text>
          ËøîÂõûÂ∞áÊúÉÈáçÁΩÆÊâÄÊúâË®ìÁ∑¥ÈÄ≤Â∫¶ÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn variant="text" @click="showBackConfirmDialog = false">ÂèñÊ∂à</v-btn>
          <v-btn color="error" variant="elevated" @click="confirmGoBack">Á¢∫ÂÆöËøîÂõû</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- ÊèêÁ§∫Ë®äÊÅØ -->
    <v-snackbar v-model="snackbar.show" :color="snackbar.color" timeout="3000" location="top">
      {{ snackbar.text }}
    </v-snackbar>
  </div>
</template>

<script setup lang="ts">
  import { ref, computed, onMounted, onUnmounted, watch, nextTick, shallowRef } from 'vue'
  import mapboxgl from 'mapbox-gl'
  import 'mapbox-gl/dist/mapbox-gl.css'
  import {
    Chart,
    CategoryScale,
    LinearScale,
    PointElement,
    LineElement,
    Title,
    Tooltip,
    Legend,
    LineController
  } from 'chart.js'
  import { createModuleLogger } from '~/utils/logger'
  import { useAppControl } from '~/composables/useAppControl'
  import { useFlTraining, type AppName, type TrainingMode } from '~/composables/useFlTraining'
  import { useTrainingResults, type NESTrainingResults } from '~/composables/useTrainingResults'
  import { Api, type RU } from '~/apis/Api'

  const log = createModuleLogger('AISimulator')

  // API client for fetching RU data
  const runtimeConfig = useRuntimeConfig()
  const apiClient = new Api({ baseURL: runtimeConfig.public.apiBaseUrl as string || '' })
  const route = useRoute()
  const projectId = computed(() => route.params.projectId as string)

  // App Control API
  const { createApp, enableApp, updateApp, deleteApp, isLoading: appControlLoading, error: appControlError } = useAppControl()

  // FL Training API
  const {
    pushTrainingTask,
    deleteTrainingTask,
    getTaskStatus,
    getControllerStatus,
    startStatusPolling,
    stopStatusPolling,
    isLoading: flTrainingLoading,
    error: flTrainingError,
    lastTaskStatus,
    currentTaskStatus,
    isTaskRunning
  } = useFlTraining()

  // Training parameters (user configurable)
  const trainingEpochs = ref(100)
  const trainingLearningRate = ref(0.001)

  // Training Results from MongoDB
  const {
    fetchTrainingResults,
    startResultsPolling,
    stopResultsPolling,
    currentResults: mongoResults,
    nesResults,
    latestActorLoss,
    latestCriticLoss,
    latestReward,
    epochProgress,
    isPolling: isResultsPolling
  } = useTrainingResults()

  // FL Training task status from API
  const flTaskStatus = ref<'running' | 'waiting' | 'not in queue' | null>(null)

  // Developer mode for controller status (activated by 10 clicks on title)
  // This feature allows developers to view the FL Controller ASM status for debugging
  const devModeClickCount = ref(0)
  const showDevMode = ref(false)
  const controllerStatus = ref<{ current_state: string; is_activate: boolean; is_final: boolean } | null>(null)
  let devModeClickTimer: ReturnType<typeof setTimeout> | null = null

  /**
   * Handle developer mode activation via rapid clicks on title
   * User must click 10 times within 3 seconds to activate
   * This is intentionally hidden from normal users for debugging purposes
   */
  function handleDevModeClick() {
    devModeClickCount.value++

    // Reset the timer on each click
    if (devModeClickTimer) {
      clearTimeout(devModeClickTimer)
    }

    // Reset click count after 3 seconds of inactivity
    devModeClickTimer = setTimeout(() => {
      devModeClickCount.value = 0
    }, 3000)

    // Activate developer mode after 10 clicks
    if (devModeClickCount.value >= 10) {
      devModeClickCount.value = 0
      showDevMode.value = true
      log.info('Developer mode activated - Fetching FL Controller status')
      refreshControllerStatus()
    }
  }

  /**
   * Refresh the FL Controller ASM status
   * Logs the status to console for debugging
   */
  async function refreshControllerStatus() {
    try {
      const response = await getControllerStatus()

      if (response.success && response.data) {
        controllerStatus.value = response.data
        // Log to console for debugging
        console.group('%c FL Controller Status', 'color: #00BCD4; font-weight: bold;')
        console.log('Current State:', response.data.current_state)
        console.log('Is Activate:', response.data.is_activate)
        console.log('Is Final:', response.data.is_final)
        console.groupEnd()
        log.debug('Controller status fetched:', response.data)
      } else {
        // API returned error but we should still show something
        controllerStatus.value = {
          current_state: 'ERROR',
          is_activate: false,
          is_final: false
        }
        console.warn('%c FL Controller Status Error', 'color: #F44336; font-weight: bold;', response.error)
        log.warn('Failed to fetch controller status:', response.error)
      }
    } catch (err) {
      controllerStatus.value = {
        current_state: 'UNREACHABLE',
        is_activate: false,
        is_final: false
      }
      console.error('%c FL Controller Unreachable', 'color: #F44336; font-weight: bold;', err)
      log.error('Error fetching controller status:', err)
    }
  }

  // Ë®ªÂÜä Chart.js ÁµÑ‰ª∂
  Chart.register(
    CategoryScale,
    LinearScale,
    PointElement,
    LineElement,
    Title,
    Tooltip,
    Legend,
    LineController
  )

  log.lifecycle('setup:start')
  const config = useRuntimeConfig()
  const isOnline = config.public?.isOnline

  // Âú∞ÂúñÁõ∏Èóú
  let map: mapboxgl.Map | null = null
  const mapAccessToken = 'pk.eyJ1IjoiZGFyaXVzbHVuZyIsImEiOiJjbHk3MWhvZW4wMTl6MmlxMnVhNzI3cW0yIn0.WGvtamOAfwfk3Ha4KsL3BQ'
  // ‰ΩøÁî®ÂúãÂúüÊ∏¨Áπ™‰∏≠ÂøÉ WMTS ÂúñË≥áÔºàËàá overviews È†ÅÈù¢‰∏ÄËá¥Ôºâ
  const onlineStyle: mapboxgl.StyleSpecification = {
    version: 8,
    sources: {
      'nlsc-emap': {
        type: 'raster',
        tiles: [
          'https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}'
        ],
        tileSize: 256,
        attribution: '&copy; <a href="https://maps.nlsc.gov.tw/" target="_blank">ÂúãÂúüÊ∏¨Áπ™‰∏≠ÂøÉ</a>'
      }
    },
    layers: [
      {
        id: 'nlsc-emap-layer',
        type: 'raster',
        source: 'nlsc-emap',
        minzoom: 0,
        maxzoom: 20
      }
    ]
  }
  const offlineStyle = config.public?.offlineMapboxGLJSURL

  // Model ÂàóË°® (Figma 277:952)
  // Available models for FL Training: NES, Positioning, RSM
  const modelList = [
    { id: 'nes', name: 'NES' },          // Network Energy Saving
    { id: 'positioning', name: 'Positioning' },  // UE Positioning
    { id: 'rsm', name: 'RSM' },          // Radio Slicing Management (Êñ∞Â¢û)
    { id: 'im', name: 'IM' },            // Interference Management
    { id: 'mro', name: 'MRO' },          // Mobility Robustness Optimization
    { id: 'rs', name: 'RS' },            // Resource Scheduling
    { id: 'bc', name: 'BC' }             // Beam Control
  ]

  const selectedModel = ref<string | null>(null)

  // NES Model ÊéßÂà∂ (Figma 277:465)
  const nesModelSelect = ref<string | null>(null)
  const nesModelOptions = [
    { title: 'Model 1 (v0.0.1)', value: '0.0.1' },
    { title: 'Model 2 (v0.0.2)', value: '0.0.2' },
    { title: 'Model 3 (v0.0.3)', value: '0.0.3' }
  ]

  // Positioning Model ÊéßÂà∂ (Figma 277:907)
  const posModelSelect = ref<string | null>(null)
  const posModelOptions = ['Model A', 'Model B', 'Model C']

  // RSM (Radio Slicing Management) Model ÊéßÂà∂
  const rsmModelSelect = ref<string | null>(null)
  const rsmModelOptions = [
    { title: 'RSM Model 1 (v1.0.0)', value: '1.0.0' },
    { title: 'RSM Model 2 (v1.0.1)', value: '1.0.1' },
    { title: 'RSM Model 3 (v1.1.0)', value: '1.1.0' }
  ]
  const rsmTrainingStatus = ref<TrainingStatus>('idle')
  const rsmEnableMode = ref(false)

  // Ë®ìÁ∑¥ÁãÄÊÖã
  type TrainingStatus = 'idle' | 'running' | 'finish'
  const trainingStatus = ref<TrainingStatus>('idle')
  const trainingEpoch = ref(0)
  const trainingResults = ref({
    reward: 0,
    actorLoss: 0,
    criticLoss: 0
  })

  // Positioning Ë®ìÁ∑¥ÁãÄÊÖã
  const posTrainingStatus = ref<TrainingStatus>('idle')
  const posTrainingEpoch = ref(0)
  const posTrainingResults = ref({
    trainLoss: 0,
    valLoss: 0
  })

  // Positioning Review Ê®°ÂºèÁãÄÊÖã (Figma 277:599, 277:652, 277:702)
  const posReviewMode = ref(false)
  const showReviewHeatmap = ref(false)
  const reviewHeatmapType = ref('RSRP')
  let reviewMap: mapboxgl.Map | null = null

  // Ë∑ØÂæëÊï∏ÊìöÈ°ûÂûã
  interface PathPoint {
    lng: number
    lat: number
  }
  interface PathData {
    id: number
    points: PathPoint[]
    uePosition: PathPoint
  }
  const posPathData = ref<PathData[]>([])

  // Positioning Finetune ÁãÄÊÖã (Figma 277:993, 277:1032)
  const posPretrainDone = ref(false)
  const posFinetuneStatus = ref<TrainingStatus>('idle')
  const posFinetuneEpoch = ref(0)
  const posFinetuneResults = ref({
    trainLoss: 0,
    valLoss: 0
  })
  // IMPORTANT: Use shallowRef to prevent deep reactivity stack overflow
  const posFinetuneData = shallowRef({
    epochs: [] as number[],
    trainLosses: [] as number[],
    valLosses: [] as number[]
  })

  // Positioning Enable Ê®°ÂºèÁãÄÊÖã (Figma 277:1190)
  const posEnableMode = ref(false)
  const showEnableHeatmap = ref(true)
  const enableSignalType = ref('RSRP')
  let enableMap: mapboxgl.Map | null = null

  // Positioning Upload Â∞çË©±Ê°ÜÁãÄÊÖã (Figma 277:1070)
  const showPosUploadDialog = ref(false)
  const posUploadDataset = ref<string | null>(null)
  const posDatasetOptions = ['Dataset A', 'Dataset B', 'Dataset C']

  // NES Review Ê®°ÂºèÁãÄÊÖã (Figma 277:1286, 277:296)
  const nesReviewMode = ref(false)
  const nesScenarioOptions = ['None', '‰∏äÁè≠', '‰∏ãÁè≠', '‰∏äË™≤1/Èö®Ê©ü', '‰∏äË™≤2/ÂêåÊ≠•']
  const nesSelectedScenario = ref('None')
  const showNesHeatmap = ref(false)
  const nesHeatmapType = ref('RSRP')
  let nesReviewMap: mapboxgl.Map | null = null

  // RU Ê®ôË®òÊï∏Êìö - Âæû API ÂãïÊÖãÁç≤Âèñ
  interface RUMarker {
    id: number
    lng: number
    lat: number
    name: string
    color: string
  }
  // RU data fetched from API (use ref for reactive updates)
  const ruMarkers = ref<RUMarker[]>([])
  const ruDataLoaded = ref(false)

  // Fallback RU markers (used if API fails) - Â∑•Á®ãÂõõÈ§®È†êË®≠‰ΩçÁΩÆ
  const defaultRuMarkers: RUMarker[] = [
    { id: 1, lng: 120.9967, lat: 24.7870, name: 'RU-1', color: '#00BCD4' },
    { id: 2, lng: 120.9972, lat: 24.7868, name: 'RU-2', color: '#E91E63' },
    { id: 3, lng: 120.9962, lat: 24.7872, name: 'RU-3', color: '#FFEB3B' },
    { id: 4, lng: 120.9970, lat: 24.7865, name: 'RU-4', color: '#4CAF50' }
  ]

  // Fetch RU data from backend API
  async function fetchRuData() {
    if (ruDataLoaded.value) return

    const pid = parseInt(projectId.value) || 26
    log.info('Fetching RU data for project:', pid)

    try {
      const response = await apiClient.project.getProjectRUs(pid)
      if (response.data && Array.isArray(response.data) && response.data.length > 0) {
        // Map API response to RUMarker format
        const colors = ['#00BCD4', '#E91E63', '#FFEB3B', '#4CAF50', '#9C27B0', '#FF5722']
        ruMarkers.value = response.data.map((ru: RU, index: number) => ({
          id: ru.RU_id || index + 1,
          lng: ru.lon || 120.9967,
          lat: ru.lat || 24.787,
          name: ru.name || `RU-${index + 1}`,
          color: colors[index % colors.length]
        }))
        log.info(`RU data loaded from API: ${ruMarkers.value.length} markers`)
      } else {
        log.warn('No RU data from API, using defaults')
        ruMarkers.value = defaultRuMarkers
      }
    } catch (error) {
      log.error('Failed to fetch RU data:', error)
      ruMarkers.value = defaultRuMarkers
    }

    ruDataLoaded.value = true
  }

  // NES Finetune ÁãÄÊÖã (Figma 277:1326, 277:1366, 277:1405)
  const nesPretrainDone = ref(false)
  const nesFinetuneStatus = ref<TrainingStatus>('idle')
  const nesFinetuneEpoch = ref(0)
  const nesFinetuneResults = ref({
    reward: 0,
    actorLoss: 0,
    criticLoss: 0
  })
  // IMPORTANT: Use shallowRef to prevent deep reactivity stack overflow
  const nesFinetuneData = shallowRef({
    epochs: [] as number[],
    rewards: [] as number[],
    rewardsMA10: [] as number[],
    bestRewards: [] as number[],
    bestRewardsMA10: [] as number[],
    criticLosses: [] as number[],
    actorLosses: [] as number[]
  })

  // NES Upload Â∞çË©±Ê°ÜÁãÄÊÖã
  const showNesUploadDialog = ref(false)
  const nesUploadDataset = ref<string | null>(null)
  // Go Back Á¢∫Ë™çÂ∞çË©±Ê°ÜÁãÄÊÖã
  const showBackConfirmDialog = ref(false)
  const nesDatasetOptions = ['Dataset A', 'Dataset B', 'Dataset C']

  // NES Enable Ê®°ÂºèÁãÄÊÖã
  const nesEnableMode = ref(false)
  let nesEnableMap: mapboxgl.Map | null = null

  // NES Dashboard Ê®°ÂºèÁãÄÊÖã (Figma 277:1526, 277:1561)
  const nesDashboardMode = ref(false)
  const nesDashboardData = ref({
    numOfUEs: 100,
    dlThroughput: 5375,
    energyUsage: 444,
    radioPower: [0, 18, 0, 18, 0]
  })

  // ÂúñË°® refs
  const rewardChartRef = ref<HTMLCanvasElement | null>(null)
  const criticLossChartRef = ref<HTMLCanvasElement | null>(null)
  const actorLossChartRef = ref<HTMLCanvasElement | null>(null)
  const posLossChartRef = ref<HTMLCanvasElement | null>(null)
  const posFinetuneChartRef = ref<HTMLCanvasElement | null>(null)
  // NES Finetune ÂúñË°® refs
  const nesFinetuneRewardChartRef = ref<HTMLCanvasElement | null>(null)
  const nesFinetuneCriticLossChartRef = ref<HTMLCanvasElement | null>(null)
  const nesFinetuneActorLossChartRef = ref<HTMLCanvasElement | null>(null)

  // Chart.js ÂØ¶‰æã (‰ΩøÁî® shallowRef ÈÅøÂÖçÊ∑±Â∫¶ÈüøÊáâ)
  const rewardChart = shallowRef<Chart | null>(null)
  const criticLossChart = shallowRef<Chart | null>(null)
  const actorLossChart = shallowRef<Chart | null>(null)
  const posLossChart = shallowRef<Chart | null>(null)
  const posFinetuneChart = shallowRef<Chart | null>(null)
  // NES Finetune ÂúñË°®ÂØ¶‰æã
  const nesFinetuneRewardChart = shallowRef<Chart | null>(null)
  const nesFinetuneCriticLossChart = shallowRef<Chart | null>(null)
  const nesFinetuneActorLossChart = shallowRef<Chart | null>(null)

  // Ë®ìÁ∑¥Êï∏ÊìöÂ≠òÂÑ≤ (NES)
  // IMPORTANT: Use shallowRef to prevent deep reactivity tracking on arrays
  // This avoids "Maximum call stack size exceeded" when pushing to arrays frequently
  const trainingData = shallowRef({
    epochs: [] as number[],
    rewards: [] as number[],
    rewardsMA10: [] as number[],
    bestRewards: [] as number[],
    bestRewardsMA10: [] as number[],
    criticLosses: [] as number[],
    actorLosses: [] as number[]
  })

  // Positioning Ë®ìÁ∑¥Êï∏ÊìöÂ≠òÂÑ≤
  // IMPORTANT: Use shallowRef to prevent deep reactivity tracking
  const posTrainingData = shallowRef({
    epochs: [] as number[],
    trainLosses: [] as number[],
    valLosses: [] as number[]
  })

  // ÊòØÂê¶Ê≠£Âú®Ë®ìÁ∑¥Ôºà‰ªª‰∏ÄÊ®°ÂûãÔºâ
  const isTrainingActive = computed(() => {
    return trainingStatus.value !== 'idle' || posTrainingStatus.value !== 'idle'
  })

  // Heatmap ÊéßÂà∂
  const showHeatmap = ref(false)
  const heatmapType = ref('RSRP')

  const snackbar = ref({ show: false, text: '', color: 'info' })

  // Ë®àÁÆóÁßªÂãïÂπ≥Âùá (MA10)
  function calculateMA(data: number[], windowSize: number = 10): number[] {
    const result: number[] = []
    for (let i = 0; i < data.length; i++) {
      if (i < windowSize - 1) {
        // Êï∏Êìö‰∏çË∂≥ÊôÇÔºå‰ΩøÁî®ÂèØÁî®Êï∏ÊìöÁöÑÂπ≥Âùá
        const slice = data.slice(0, i + 1)
        result.push(slice.reduce((a, b) => a + b, 0) / slice.length)
      } else {
        const slice = data.slice(i - windowSize + 1, i + 1)
        result.push(slice.reduce((a, b) => a + b, 0) / windowSize)
      }
    }
    return result
  }

  // ÂàùÂßãÂåñÂúñË°®
  function initCharts() {
    destroyCharts()

    nextTick(() => {
      // Reward ÂúñË°® (‰∏ªÂúñË°®Ôºå4 Ê¢ùÁ∑ö)
      if (rewardChartRef.value) {
        const ctx = rewardChartRef.value.getContext('2d')
        if (ctx) {
          rewardChart.value = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'reward',
                  data: [],
                  borderColor: '#2196F3',
                  backgroundColor: 'transparent',
                  borderWidth: 1,
                  pointRadius: 0,
                  tension: 0.1
                },
                {
                  label: 'reward (MA10)',
                  data: [],
                  borderColor: '#64B5F6',
                  backgroundColor: 'transparent',
                  borderWidth: 2,
                  pointRadius: 0,
                  tension: 0.3
                },
                {
                  label: 'bestReward',
                  data: [],
                  borderColor: '#4CAF50',
                  backgroundColor: 'transparent',
                  borderWidth: 1,
                  pointRadius: 0,
                  tension: 0.1
                },
                {
                  label: 'bestReward (MA10)',
                  data: [],
                  borderColor: '#FFD600',
                  backgroundColor: 'transparent',
                  borderWidth: 2,
                  pointRadius: 0,
                  tension: 0.3
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              scales: {
                x: {
                  title: { display: true, text: 'epoch', font: { size: 10 } },
                  ticks: { font: { size: 9 }, maxTicksLimit: 6 }
                },
                y: {
                  title: { display: true, text: 'value', font: { size: 10 } },
                  ticks: { font: { size: 9 } },
                  min: 0.4,
                  max: 1.1
                }
              },
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { font: { size: 9 }, boxWidth: 20, padding: 8 }
                },
                tooltip: { enabled: true, mode: 'index', intersect: false }
              }
            }
          })
        }
      }

      // Critic Loss ÂúñË°® (Â∑¶‰∏ã)
      if (criticLossChartRef.value) {
        const ctx = criticLossChartRef.value.getContext('2d')
        if (ctx) {
          criticLossChart.value = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [{
                label: 'critic_loss',
                data: [],
                borderColor: '#FFC107',
                backgroundColor: 'transparent',
                borderWidth: 1.5,
                pointRadius: 0,
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              scales: {
                x: {
                  title: { display: true, text: 'epoch', font: { size: 9 } },
                  ticks: { font: { size: 8 }, maxTicksLimit: 5 }
                },
                y: {
                  title: { display: true, text: 'critic_loss', font: { size: 9 } },
                  ticks: { font: { size: 8 } }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
              }
            }
          })
        }
      }

      // Actor Loss ÂúñË°® (Âè≥‰∏ã)
      if (actorLossChartRef.value) {
        const ctx = actorLossChartRef.value.getContext('2d')
        if (ctx) {
          actorLossChart.value = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [{
                label: 'actor_loss',
                data: [],
                borderColor: '#FF9800',
                backgroundColor: 'transparent',
                borderWidth: 1.5,
                pointRadius: 0,
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              scales: {
                x: {
                  title: { display: true, text: 'epoch', font: { size: 9 } },
                  ticks: { font: { size: 8 }, maxTicksLimit: 5 }
                },
                y: {
                  title: { display: true, text: 'actor_loss', font: { size: 9 } },
                  ticks: { font: { size: 8 } }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
              }
            }
          })
        }
      }
    })
  }

  // Èä∑ÊØÄÂúñË°®
  function destroyCharts() {
    if (rewardChart.value) {
      rewardChart.value.destroy()
      rewardChart.value = null
    }
    if (criticLossChart.value) {
      criticLossChart.value.destroy()
      criticLossChart.value = null
    }
    if (actorLossChart.value) {
      actorLossChart.value.destroy()
      actorLossChart.value = null
    }
    if (posLossChart.value) {
      posLossChart.value.destroy()
      posLossChart.value = null
    }
    if (posFinetuneChart.value) {
      posFinetuneChart.value.destroy()
      posFinetuneChart.value = null
    }
  }

  // Êõ¥Êñ∞ÂúñË°®Êï∏Êìö
  // IMPORTANT: Use spread operator to create copies of reactive arrays
  // to avoid Vue Proxy <-> Chart.js circular reactivity causing stack overflow
  function updateCharts() {
    const data = trainingData.value

    // Êõ¥Êñ∞ Reward ÂúñË°®
    if (rewardChart.value) {
      // Create copies of arrays to break Vue reactivity chain
      rewardChart.value.data.labels = [...data.epochs]
      rewardChart.value.data.datasets[0].data = [...data.rewards]
      rewardChart.value.data.datasets[1].data = [...data.rewardsMA10]
      rewardChart.value.data.datasets[2].data = [...data.bestRewards]
      rewardChart.value.data.datasets[3].data = [...data.bestRewardsMA10]
      rewardChart.value.update('none')
    }

    // Êõ¥Êñ∞ Critic Loss ÂúñË°®
    if (criticLossChart.value) {
      criticLossChart.value.data.labels = [...data.epochs]
      criticLossChart.value.data.datasets[0].data = [...data.criticLosses]
      criticLossChart.value.update('none')
    }

    // Êõ¥Êñ∞ Actor Loss ÂúñË°®
    if (actorLossChart.value) {
      actorLossChart.value.data.labels = [...data.epochs]
      actorLossChart.value.data.datasets[0].data = [...data.actorLosses]
      actorLossChart.value.update('none')
    }
  }

  /**
   * Update charts with data from MongoDB Training_Results database
   * This function is called when training results are fetched from the FL Training API
   *
   * @param results - NES Training results from MongoDB
   */
  function updateChartsFromMongoDB(results: NESTrainingResults) {
    if (!results) return

    // Generate epoch labels
    const epochs = Array.from({ length: results.current_epoch + 1 }, (_, i) => i)

    // Calculate moving averages for rewards
    // Use spread operator to ensure we're working with plain arrays, not reactive proxies
    const rewardsArray = [...(results.reward || [])]
    const criticLossArray = [...(results.critic_loss || [])]
    const actorLossArray = [...(results.actor_loss || [])]

    const rewardsMA10 = calculateMovingAverage(rewardsArray, 10)
    const bestRewards = calculateRunningMax(rewardsArray)
    const bestRewardsMA10 = calculateMovingAverage(bestRewards, 10)

    // Update training data reactive object with plain arrays
    trainingData.value = {
      epochs,
      rewards: rewardsArray,
      rewardsMA10,
      bestRewards,
      bestRewardsMA10,
      criticLosses: criticLossArray,
      actorLosses: actorLossArray
    }

    // Update epoch display
    trainingEpoch.value = results.current_epoch

    // Update training results display
    trainingResults.value = {
      reward: results.reward[results.reward.length - 1] || 0,
      actorLoss: results.actor_loss[results.actor_loss.length - 1] || 0,
      criticLoss: results.critic_loss[results.critic_loss.length - 1] || 0
    }

    // Update the actual Chart.js instances
    updateCharts()

    log.debug('Charts updated from MongoDB results', {
      epochs: results.current_epoch,
      totalEpochs: results.total_epochs
    })
  }

  /**
   * Calculate moving average for an array of numbers
   *
   * @param data - Input array
   * @param windowSize - Moving average window size
   * @returns Moving average array
   */
  function calculateMovingAverage(data: number[], windowSize: number): number[] {
    const result: number[] = []
    for (let i = 0; i < data.length; i++) {
      const start = Math.max(0, i - windowSize + 1)
      const window = data.slice(start, i + 1)
      const avg = window.reduce((a, b) => a + b, 0) / window.length
      result.push(avg)
    }
    return result
  }

  /**
   * Calculate running maximum for an array of numbers
   *
   * @param data - Input array
   * @returns Running maximum array
   */
  function calculateRunningMax(data: number[]): number[] {
    const result: number[] = []
    let runningMax = -Infinity
    for (const value of data) {
      runningMax = Math.max(runningMax, value)
      result.push(runningMax)
    }
    return result
  }

  /**
   * Start fetching training results from MongoDB and update charts
   * This connects to the FL Training API which proxies to MongoDB
   */
  async function startMongoDBResultsSync() {
    if (!nesModelSelect.value || !projectId.value) return

    log.info('Starting MongoDB results sync')

    startResultsPolling(
      {
        project_id: projectId.value,
        app_name: 'NES',
        model_version: nesModelSelect.value
      },
      'pretrain',
      3000,
      (results) => {
        if (results.app_name === 'NES') {
          updateChartsFromMongoDB(results as NESTrainingResults)
        }
      }
    )
  }

  /**
   * Stop fetching training results from MongoDB
   */
  function stopMongoDBResultsSync() {
    stopResultsPolling()
    log.info('MongoDB results sync stopped')
  }

  // ÈáçÁΩÆË®ìÁ∑¥Êï∏Êìö
  function resetTrainingData() {
    trainingData.value = {
      epochs: [],
      rewards: [],
      rewardsMA10: [],
      bestRewards: [],
      bestRewardsMA10: [],
      criticLosses: [],
      actorLosses: []
    }
  }

  // ÈáçÁΩÆ Positioning Ë®ìÁ∑¥Êï∏Êìö
  function resetPosTrainingData() {
    posTrainingData.value = {
      epochs: [],
      trainLosses: [],
      valLosses: []
    }
  }

  // ÂàùÂßãÂåñ Positioning Loss ÂúñË°®
  function initPosChart() {
    if (posLossChart.value) {
      posLossChart.value.destroy()
      posLossChart.value = null
    }

    nextTick(() => {
      if (posLossChartRef.value) {
        const ctx = posLossChartRef.value.getContext('2d')
        if (ctx) {
          posLossChart.value = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'training',
                  data: [],
                  borderColor: '#2196F3',
                  backgroundColor: 'transparent',
                  borderWidth: 2,
                  pointRadius: 0,
                  tension: 0.1
                },
                {
                  label: 'validation',
                  data: [],
                  borderColor: '#FF9800',
                  backgroundColor: 'transparent',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  pointRadius: 0,
                  tension: 0.1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              scales: {
                x: {
                  title: { display: true, text: 'epoch', font: { size: 10 } },
                  ticks: { font: { size: 9 }, maxTicksLimit: 6 }
                },
                y: {
                  title: { display: true, text: 'loss', font: { size: 10 } },
                  ticks: { font: { size: 9 } },
                  min: 0
                }
              },
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { font: { size: 10 }, boxWidth: 20, padding: 10 }
                },
                tooltip: { enabled: true, mode: 'index', intersect: false }
              }
            }
          })
        }
      }
    })
  }

  // Êõ¥Êñ∞ Positioning ÂúñË°®Êï∏Êìö
  // IMPORTANT: Use spread operator to avoid Vue Proxy <-> Chart.js circular reactivity
  function updatePosChart() {
    const data = posTrainingData.value
    if (posLossChart.value) {
      posLossChart.value.data.labels = [...data.epochs]
      posLossChart.value.data.datasets[0].data = [...data.trainLosses]
      posLossChart.value.data.datasets[1].data = [...data.valLosses]
      posLossChart.value.update('none')
    }
  }

  // ÈÅ∏ÊìáÊ®°Âûã
  function selectModel(modelId: string) {
    selectedModel.value = modelId
    // ÈáçÁΩÆ NES ÁãÄÊÖã
    trainingStatus.value = 'idle'
    trainingEpoch.value = 0
    nesModelSelect.value = null
    resetTrainingData()
    // ÈáçÁΩÆ Positioning ÁãÄÊÖã
    posTrainingStatus.value = 'idle'
    posTrainingEpoch.value = 0
    posModelSelect.value = null
    resetPosTrainingData()
  }

  // ËøîÂõû Model List
  // Check if there's active training or completed training progress
  function goBack() {
    const hasTrainingProgress =
      nesPretrainDone.value ||
      posPretrainDone.value ||
      trainingStatus.value !== 'idle' ||
      posTrainingStatus.value !== 'idle' ||
      nesFinetuneStatus.value !== 'idle' ||
      posFinetuneStatus.value !== 'idle'

    if (hasTrainingProgress) {
      // Show confirmation dialog instead of immediately resetting
      showBackConfirmDialog.value = true
    } else {
      // No progress to lose, proceed directly
      confirmGoBack()
    }
  }

  // Performs the actual reset after user confirms (or if no progress exists)
  function confirmGoBack() {
    showBackConfirmDialog.value = false
    selectedModel.value = null
    // ÈáçÁΩÆ NES ÁãÄÊÖã
    trainingStatus.value = 'idle'
    trainingEpoch.value = 0
    nesModelSelect.value = null
    resetTrainingData()
    // ÈáçÁΩÆ NES Review ÁãÄÊÖã
    nesReviewMode.value = false
    nesSelectedScenario.value = 'None'
    if (nesReviewMap) {
      nesReviewMap.remove()
      nesReviewMap = null
    }
    // ÈáçÁΩÆ NES Finetune/Enable ÁãÄÊÖã
    nesPretrainDone.value = false
    nesFinetuneStatus.value = 'idle'
    nesFinetuneEpoch.value = 0
    nesEnableMode.value = false
    nesDashboardMode.value = false
    if (nesEnableMap) {
      nesEnableMap.remove()
      nesEnableMap = null
    }
    if (nesFinetuneInterval) {
      clearInterval(nesFinetuneInterval)
      nesFinetuneInterval = null
    }
    destroyNesFinetuneCharts()
    // ÈáçÁΩÆ Positioning ÁãÄÊÖã
    posTrainingStatus.value = 'idle'
    posTrainingEpoch.value = 0
    posModelSelect.value = null
    resetPosTrainingData()
    // ÈÄÄÂá∫ Review Ê®°Âºè
    posReviewMode.value = false
    posPathData.value = []
    if (reviewMap) {
      reviewMap.remove()
      reviewMap = null
    }
    // ÈáçÁΩÆ Finetune/Enable ÁãÄÊÖã
    posPretrainDone.value = false
    posFinetuneStatus.value = 'idle'
    posFinetuneEpoch.value = 0
    posEnableMode.value = false
    if (enableMap) {
      enableMap.remove()
      enableMap = null
    }
    // ÂÅúÊ≠¢Ë®ìÁ∑¥
    if (trainingInterval) {
      clearInterval(trainingInterval)
      trainingInterval = null
    }
    if (posTrainingInterval) {
      clearInterval(posTrainingInterval)
      posTrainingInterval = null
    }
    destroyCharts()
    // ÈáçÊñ∞ÂàùÂßãÂåñÂú∞Âúñ
    nextTick(() => initializeMap())
  }

  // ÈñãÂßãÈ†êË®ìÁ∑¥ (Pre-train ÊåâÈàï)
  // Integrates with FL Training API at http://140.113.144.121:9005
  async function startPreTrain() {
    if (!nesModelSelect.value) return

    try {
      // First, call App Control API to create the NES app instance
      const appResponse = await createApp({
        project_id: projectId.value || 'ED8F',
        app_id: 'NES',
        version_id: nesModelSelect.value
      })

      log.info('NES app created for pre-train:', appResponse)

      // Then, push the training task to FL Training API
      const flResponse = await pushTrainingTask(
        projectId.value || 'ED8F',
        'NES' as AppName,
        nesModelSelect.value,
        'pre train' as TrainingMode,
        trainingEpochs.value,
        trainingLearningRate.value
      )

      if (flResponse.success) {
        log.info('FL training task pushed successfully:', flResponse)

        snackbar.value = {
          show: true,
          text: `NES Ê®°Âûã ${nesModelSelect.value} Ë®ìÁ∑¥‰ªªÂãôÂ∑≤Êèê‰∫§ (Epochs: ${trainingEpochs.value}, LR: ${trainingLearningRate.value})`,
          color: 'success'
        }

        // Start polling for task status
        startStatusPolling(
          projectId.value || 'ED8F',
          'NES' as AppName,
          nesModelSelect.value,
          'pre train' as TrainingMode,
          5000,
          (status) => {
            flTaskStatus.value = status.status
            log.debug('FL task status update:', status)

            // If task finished, update UI
            if (status.status === 'not in queue' && trainingStatus.value === 'running') {
              nesPretrainDone.value = true
              trainingStatus.value = 'finish'
              stopStatusPolling()
              stopResultsPolling()

              // Show completion message with enable prompt
              snackbar.value = {
                show: true,
                text: 'Pre-train ÂÆåÊàêÔºÅÈªûÊìä Review Ê™¢Ë¶ñÁµêÊûúÔºåÊàñÈªûÊìä Update ÈÄ≤ÂÖ• Finetune ÈöéÊÆµ',
                color: 'success'
              }
            }
          }
        )
      } else {
        throw new Error(flResponse.error || 'FL Training API error')
      }
    } catch (err) {
      log.error('Failed to start pre-train:', err)
      snackbar.value = {
        show: true,
        text: `Ë®ìÁ∑¥ÂïüÂãïÂ§±Êïó: ${flTrainingError.value || appControlError.value || 'ÁÑ°Ê≥ïÈÄ£Êé•Âà∞Ë®ìÁ∑¥Âπ≥Âè∞'}`,
        color: 'error'
      }
    }
  }

  // ÈñãÂßãË®ìÁ∑¥ (START ÊåâÈàï)
  function startTraining() {
    if (!nesModelSelect.value) {
      snackbar.value = {
        show: true,
        text: 'Ë´ãÂÖàÈÅ∏ÊìáÊ®°Âûã',
        color: 'warning'
      }
      return
    }

    trainingStatus.value = 'running'
    trainingEpoch.value = 0
    resetTrainingData()

    // ÂàùÂßãÂåñÂúñË°®
    nextTick(() => {
      initCharts()
      // ÈñãÂßãÊ®°Êì¨Ë®ìÁ∑¥
      nextTick(() => simulateTraining())
    })
  }

  // ÂÅúÊ≠¢Ë®ìÁ∑¥ (STOP ÊåâÈàï)
  // Calls FL Training API to delete the training task and cleans up App Control resources
  async function stopTraining() {
    // Stop local simulation interval
    if (trainingInterval) {
      clearInterval(trainingInterval)
      trainingInterval = null
    }

    // Stop FL status polling
    stopStatusPolling()

    // Stop MongoDB results polling
    stopResultsPolling()

    // If we have a model selected, delete the task from FL Training API and clean up App Control
    if (nesModelSelect.value) {
      // Delete FL training task
      try {
        const flResponse = await deleteTrainingTask(
          projectId.value || 'ED8F',
          'NES' as AppName,
          nesModelSelect.value,
          'pre train' as TrainingMode
        )

        if (flResponse.success) {
          log.info('FL training task deleted successfully')
        } else {
          log.warn('Failed to delete FL training task:', flResponse.error)
        }
      } catch (err) {
        log.error('Error deleting FL training task:', err)
      }

      // Clean up App Control resources (container created by createApp)
      try {
        await deleteApp({
          project_id: projectId.value || 'ED8F',
          app_id: 'NES',
          version_id: nesModelSelect.value
        })
        log.info('App Control resources cleaned up successfully')
      } catch (err) {
        log.warn('Could not delete App Control resources (may not exist):', err)
      }
    }

    // Reset local state
    trainingStatus.value = 'idle'
    flTaskStatus.value = null
    snackbar.value = {
      show: true,
      text: 'Ë®ìÁ∑¥Â∑≤ÂÅúÊ≠¢',
      color: 'info'
    }
  }

  // ========== RSM (Radio Slicing Management) Model Ë®ìÁ∑¥ÊéßÂà∂ ==========

  // ÈñãÂßã RSM È†êË®ìÁ∑¥ (Pre-train ÊåâÈàï)
  async function startRsmPretrain() {
    if (!rsmModelSelect.value) return

    try {
      // First, call App Control API to create the RSM app instance
      const appResponse = await createApp({
        project_id: projectId.value || 'ED8F',
        app_id: 'RSM',
        version_id: rsmModelSelect.value
      })

      log.info('RSM app created for pre-train:', appResponse)

      // Then, push the training task to FL Training API
      const flResponse = await pushTrainingTask(
        projectId.value || 'ED8F',
        'RSM' as AppName,
        rsmModelSelect.value,
        'pre train' as TrainingMode,
        trainingEpochs.value,
        trainingLearningRate.value
      )

      if (flResponse.success) {
        log.info('RSM FL training task pushed successfully:', flResponse)

        snackbar.value = {
          show: true,
          text: `RSM Ê®°Âûã ${rsmModelSelect.value} Ë®ìÁ∑¥‰ªªÂãôÂ∑≤Êèê‰∫§`,
          color: 'success'
        }

        rsmTrainingStatus.value = 'running'

        // Start polling for task status
        startStatusPolling(
          projectId.value || 'ED8F',
          'RSM' as AppName,
          rsmModelSelect.value,
          'pre train' as TrainingMode,
          5000,
          (status) => {
            flTaskStatus.value = status.status
            if (status.status === 'not in queue' && rsmTrainingStatus.value === 'running') {
              rsmTrainingStatus.value = 'finish'
              snackbar.value = {
                show: true,
                text: 'RSM Pre-train ÂÆåÊàêÔºÅÂèØ‰ª•ÈÄ≤Ë°å Enable',
                color: 'success'
              }
              stopStatusPolling()
            }
          }
        )
      } else {
        throw new Error(flResponse.error || 'FL Training API error')
      }
    } catch (err) {
      log.error('Failed to start RSM pre-train:', err)
      snackbar.value = {
        show: true,
        text: `RSM Ë®ìÁ∑¥ÂïüÂãïÂ§±Êïó: ${flTrainingError.value || 'ÁÑ°Ê≥ïÈÄ£Êé•Âà∞Ë®ìÁ∑¥Âπ≥Âè∞'}`,
        color: 'error'
      }
    }
  }

  // ÈñãÂßã RSM Ë®ìÁ∑¥ (START ÊåâÈàï)
  function startRsmTraining() {
    if (!rsmModelSelect.value) {
      snackbar.value = {
        show: true,
        text: 'Ë´ãÂÖàÈÅ∏Êìá RSM Ê®°Âûã',
        color: 'warning'
      }
      return
    }
    startRsmPretrain()
  }

  // ÂÅúÊ≠¢ RSM Ë®ìÁ∑¥
  // Cleans up FL Training task and App Control resources
  async function stopRsmTraining() {
    // Stop FL status polling
    stopStatusPolling()

    // Stop MongoDB results polling
    stopResultsPolling()

    if (rsmModelSelect.value) {
      // Delete FL training task
      try {
        await deleteTrainingTask(
          projectId.value || 'ED8F',
          'RSM' as AppName,
          rsmModelSelect.value,
          'pre train' as TrainingMode
        )
        log.info('RSM FL training task deleted successfully')
      } catch (err) {
        log.error('Error deleting RSM training task:', err)
      }

      // Clean up App Control resources (container created by createApp)
      try {
        await deleteApp({
          project_id: projectId.value || 'ED8F',
          app_id: 'RSM',
          version_id: rsmModelSelect.value
        })
        log.info('RSM App Control resources cleaned up successfully')
      } catch (err) {
        log.warn('Could not delete RSM App Control resources (may not exist):', err)
      }
    }

    // Reset local state
    rsmTrainingStatus.value = 'idle'
    flTaskStatus.value = null
    snackbar.value = {
      show: true,
      text: 'RSM Ë®ìÁ∑¥Â∑≤ÂÅúÊ≠¢',
      color: 'info'
    }
  }

  // ÂïüÁî® RSM Ê®°Âûã
  function enableRsmModel() {
    if (rsmTrainingStatus.value !== 'finish') return

    rsmEnableMode.value = true
    snackbar.value = {
      show: true,
      text: 'RSM Ê®°ÂûãÂ∑≤ÂïüÁî®',
      color: 'success'
    }
  }

  // ÈñãÂßã RSM Re-train
  async function startRsmRetrain() {
    if (!rsmModelSelect.value || !rsmEnableMode.value) return

    try {
      const flResponse = await pushTrainingTask(
        projectId.value || 'ED8F',
        'RSM' as AppName,
        rsmModelSelect.value,
        'retrain' as TrainingMode,
        trainingEpochs.value,
        trainingLearningRate.value
      )

      if (flResponse.success) {
        snackbar.value = {
          show: true,
          text: `RSM Re-train ‰ªªÂãôÂ∑≤Êèê‰∫§`,
          color: 'success'
        }
        rsmTrainingStatus.value = 'running'
      }
    } catch (err) {
      log.error('Failed to start RSM re-train:', err)
      snackbar.value = {
        show: true,
        text: `RSM Re-train Â§±Êïó`,
        color: 'error'
      }
    }
  }

  // Êõ¥Êñ∞Ê®°Âûã (‰æõÊú™‰æÜ‰ΩøÁî®)
  function _updateModel() {
    snackbar.value = {
      show: true,
      text: 'Update ÂäüËÉΩÂ∞öÊú™ÂØ¶‰Ωú (ÈúÄÂæåÁ´Ø API: POST /ai-simulator/pretrain/update)',
      color: 'warning'
    }
  }

  // È°ØÁ§∫È†êË¶Ω
  // ========== NES Review Ê®°ÂºèÊéßÂà∂ (Figma 277:1286, 277:296) ==========

  // È°ØÁ§∫ NES Review Ê®°Âºè
  function showNesReview() {
    nesReviewMode.value = true
    nesSelectedScenario.value = 'None'
    nextTick(() => initNesReviewMap())
  }

  // ËôïÁêÜ NES BACK ÊåâÈàï
  function handleNesBack() {
    if (nesReviewMode.value) {
      exitNesReviewMode()
      return
    }
    goBack()
  }

  // ÈÄÄÂá∫ NES Review Ê®°Âºè
  function exitNesReviewMode() {
    nesReviewMode.value = false
    nesSelectedScenario.value = 'None'
    if (nesReviewMap) {
      nesReviewMap.remove()
      nesReviewMap = null
    }
  }

  // ÂàùÂßãÂåñ NES Review Âú∞Âúñ
  async function initNesReviewMap() {
    if (nesReviewMap) {
      nesReviewMap.remove()
      nesReviewMap = null
    }

    // Fetch RU data from API before initializing map
    await fetchRuData()

    await nextTick()
    const mapContainer = document.getElementById('nesReviewMap')
    if (!mapContainer) return

    try {
      mapboxgl.accessToken = mapAccessToken
      const initialStyle = (isOnline ? onlineStyle : offlineStyle) as string | mapboxgl.StyleSpecification | undefined

      nesReviewMap = new mapboxgl.Map({
        container: 'nesReviewMap',
        style: initialStyle,
        center: [120.9967, 24.787],
        zoom: 17
      })

      nesReviewMap.addControl(new mapboxgl.NavigationControl())

      // Âú∞ÂúñËºâÂÖ•ÂÆåÊàêÂæåÊ∑ªÂä† RU Ê®ôË®ò
      nesReviewMap.on('load', () => {
        addNesRuMarkers()
      })
    } catch (error) {
      console.error('NES Review map initialization error:', error)
    }
  }

  // Ê∑ªÂä† RU Ê®ôË®òÂà∞Âú∞Âúñ (‰ΩøÁî® ru.svg ÂúñÁâá)
  function addNesRuMarkers() {
    if (!nesReviewMap) return

    const markers = ruMarkers.value.length > 0 ? ruMarkers.value : defaultRuMarkers

    markers.forEach(ru => {
      // Create marker element using ru.svg image
      const el = document.createElement('div')
      el.className = 'ru-marker'
      el.style.width = '32px'
      el.style.height = '32px'
      el.style.backgroundImage = 'url(/img/ru.svg)'
      el.style.backgroundSize = 'contain'
      el.style.backgroundRepeat = 'no-repeat'
      el.style.cursor = 'pointer'
      el.title = ru.name

      // Add popup with RU info
      const popup = new mapboxgl.Popup({ offset: 25 })
        .setHTML(`<div style="padding: 4px;"><strong>${ru.name}</strong><br/>Lng: ${ru.lng.toFixed(6)}<br/>Lat: ${ru.lat.toFixed(6)}</div>`)

      new mapboxgl.Marker(el)
        .setLngLat([ru.lng, ru.lat])
        .setPopup(popup)
        .addTo(nesReviewMap!)
    })

    log.info(`Added ${markers.length} RU markers to NES Review map`)
  }

  // Ê∑ªÂä† UE Ê®ôË®òÔºàÊ†πÊìöÂ†¥ÊôØÔºâ
  function addNesUeMarkers() {
    if (!nesReviewMap || nesSelectedScenario.value === 'None') return

    // Ê†πÊìöÂ†¥ÊôØÁîüÊàê‰∏çÂêåÁöÑ UE ‰ΩçÁΩÆ
    const uePositions = generateUePositions(nesSelectedScenario.value)

    uePositions.forEach(pos => {
      const el = document.createElement('div')
      el.innerHTML = 'üë§'
      el.style.fontSize = '16px'
      el.className = 'nes-ue-marker'

      new mapboxgl.Marker(el)
        .setLngLat([pos.lng, pos.lat])
        .addTo(nesReviewMap!)
    })
  }

  // Ê†πÊìöÂ†¥ÊôØÁîüÊàê UE ‰ΩçÁΩÆ
  function generateUePositions(scenario: string): { lng: number; lat: number }[] {
    const centerLng = 120.997
    const centerLat = 24.787
    const positions: { lng: number; lat: number }[] = []

    // Ê†πÊìö‰∏çÂêåÂ†¥ÊôØÁîüÊàê‰∏çÂêåÂàÜÂ∏ÉÁöÑ UE
    let count = 0
    let spread = 0.001

    switch (scenario) {
    case '‰∏äÁè≠':
      count = 12
      spread = 0.002
      break
    case '‰∏ãÁè≠':
      count = 15
      spread = 0.0025
      break
    case '‰∏äË™≤1/Èö®Ê©ü':
      count = 8
      spread = 0.0015
      break
    case '‰∏äË™≤2/ÂêåÊ≠•':
      count = 10
      spread = 0.0018
      break
    default:
      count = 10
      spread = 0.002
    }

    for (let i = 0; i < count; i++) {
      positions.push({
        lng: centerLng + (Math.random() - 0.5) * spread,
        lat: centerLat + (Math.random() - 0.5) * spread
      })
    }

    return positions
  }

  // Áõ£ËÅΩÂ†¥ÊôØËÆäÂåñÔºåÊõ¥Êñ∞ UE Ê®ôË®ò
  watch(nesSelectedScenario, (newScenario) => {
    if (!nesReviewMap) return

    // ÁßªÈô§ÁèæÊúâÁöÑ UE Ê®ôË®ò
    const existingMarkers = document.querySelectorAll('.nes-ue-marker')
    existingMarkers.forEach(marker => {
      const parent = marker.parentElement
      if (parent) parent.remove()
    })

    // Â¶ÇÊûúÈÅ∏Êìá‰∫ÜÂ†¥ÊôØÔºåÊ∑ªÂä†Êñ∞ÁöÑ UE Ê®ôË®ò
    if (newScenario !== 'None') {
      addNesUeMarkers()
    }
  })

  // ========== NES Finetune ÊéßÂà∂ (Figma 277:1326, 277:1366, 277:1405) ==========

  // Á¢∫Ë™ç NES Pre-train ÂÆåÊàêÔºåÈÄ≤ÂÖ• Finetune ÈöéÊÆµ
  // This function is called when user clicks Update button after Pre-train completes
  // It registers the model version update via App Control API
  async function confirmNesPretrainDone() {
    if (!nesModelSelect.value) {
      snackbar.value = {
        show: true,
        text: 'Ë´ãÂÖàÈÅ∏ÊìáÊ®°ÂûãÁâàÊú¨',
        color: 'warning'
      }
      return
    }

    try {
      // Call App Control API to update/register the pre-trained model version
      const response = await updateApp({
        project_id: projectId.value || 'ED8F',
        app_id: 'NES',
        version_id: nesModelSelect.value
      })

      log.info('NES Pre-train model registered:', response)

      nesPretrainDone.value = true
      trainingStatus.value = 'idle'
      snackbar.value = {
        show: true,
        text: `Pre-train Ê®°Âûã ${nesModelSelect.value} Â∑≤Ë®ªÂÜäÔºåÂèØ‰ª•ÈñãÂßã Finetune`,
        color: 'success'
      }
    } catch (err) {
      log.error('Failed to register Pre-train model:', err)
      // Still allow user to proceed to Finetune even if API call fails
      nesPretrainDone.value = true
      trainingStatus.value = 'idle'
      snackbar.value = {
        show: true,
        text: `Ê®°ÂûãË®ªÂÜäÂ§±Êïó (${appControlError.value || 'ÁÑ°Ê≥ïÈÄ£Êé•Âà∞Ë®àÁÆóÂπ≥Âè∞'})Ôºå‰ΩÜ‰ªçÂèØÈÄ≤Ë°å Finetune`,
        color: 'warning'
      }
    }
  }

  // È°ØÁ§∫ Upload Â∞çË©±Ê°Ü
  function showNesUploadDialogFn() {
    nesUploadDataset.value = null
    showNesUploadDialog.value = true
  }

  // Êèê‰∫§ Upload
  function submitNesUpload() {
    if (!nesUploadDataset.value) {
      snackbar.value = {
        show: true,
        text: 'Ë´ãÈÅ∏ÊìáÊï∏ÊìöÈõÜ',
        color: 'warning'
      }
      return
    }
    showNesUploadDialog.value = false
    startNesFinetuning()
  }

  // ÂèñÊ∂à Upload
  function cancelNesUpload() {
    showNesUploadDialog.value = false
    nesUploadDataset.value = null
  }

  // ÈñãÂßã NES Finetune Ë®ìÁ∑¥
  function startNesFinetuning() {
    nesFinetuneStatus.value = 'running'
    nesFinetuneEpoch.value = 0
    resetNesFinetuneData()

    nextTick(() => {
      initNesFinetuneCharts()
      nextTick(() => simulateNesFinetuning())
    })
  }

  // ÈáçÁΩÆ NES Finetune Ë®ìÁ∑¥Êï∏Êìö
  function resetNesFinetuneData() {
    nesFinetuneData.value = {
      epochs: [],
      rewards: [],
      rewardsMA10: [],
      bestRewards: [],
      bestRewardsMA10: [],
      criticLosses: [],
      actorLosses: []
    }
  }

  // ÂàùÂßãÂåñ NES Finetune ÂúñË°®
  function initNesFinetuneCharts() {
    destroyNesFinetuneCharts()

    nextTick(() => {
      // Reward ÂúñË°®
      if (nesFinetuneRewardChartRef.value) {
        const ctx = nesFinetuneRewardChartRef.value.getContext('2d')
        if (ctx) {
          nesFinetuneRewardChart.value = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                { label: 'reward', data: [], borderColor: '#2196F3', backgroundColor: 'transparent', borderWidth: 1, pointRadius: 0, tension: 0.1 },
                { label: 'reward (MA10)', data: [], borderColor: '#64B5F6', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, tension: 0.3 },
                { label: 'bestReward', data: [], borderColor: '#4CAF50', backgroundColor: 'transparent', borderWidth: 1, pointRadius: 0, tension: 0.1 },
                { label: 'bestReward (MA10)', data: [], borderColor: '#FFD600', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, tension: 0.3 }
              ]
            },
            options: {
              responsive: true, maintainAspectRatio: false, animation: false,
              scales: {
                x: { title: { display: true, text: 'epoch', font: { size: 10 } }, ticks: { font: { size: 9 }, maxTicksLimit: 6 } },
                y: { title: { display: true, text: 'value', font: { size: 10 } }, ticks: { font: { size: 9 } }, min: 0.4, max: 1.1 }
              },
              plugins: { legend: { position: 'bottom', labels: { font: { size: 9 }, boxWidth: 20, padding: 8 } }, tooltip: { enabled: true, mode: 'index', intersect: false } }
            }
          })
        }
      }

      // Critic Loss ÂúñË°®
      if (nesFinetuneCriticLossChartRef.value) {
        const ctx = nesFinetuneCriticLossChartRef.value.getContext('2d')
        if (ctx) {
          nesFinetuneCriticLossChart.value = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'critic_loss', data: [], borderColor: '#FFC107', backgroundColor: 'transparent', borderWidth: 1.5, pointRadius: 0, tension: 0.1 }] },
            options: {
              responsive: true, maintainAspectRatio: false, animation: false,
              scales: {
                x: { title: { display: true, text: 'epoch', font: { size: 9 } }, ticks: { font: { size: 8 }, maxTicksLimit: 5 } },
                y: { title: { display: true, text: 'critic_loss', font: { size: 9 } }, ticks: { font: { size: 8 } } }
              },
              plugins: { legend: { display: false }, tooltip: { enabled: true } }
            }
          })
        }
      }

      // Actor Loss ÂúñË°®
      if (nesFinetuneActorLossChartRef.value) {
        const ctx = nesFinetuneActorLossChartRef.value.getContext('2d')
        if (ctx) {
          nesFinetuneActorLossChart.value = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'actor_loss', data: [], borderColor: '#FF9800', backgroundColor: 'transparent', borderWidth: 1.5, pointRadius: 0, tension: 0.1 }] },
            options: {
              responsive: true, maintainAspectRatio: false, animation: false,
              scales: {
                x: { title: { display: true, text: 'epoch', font: { size: 9 } }, ticks: { font: { size: 8 }, maxTicksLimit: 5 } },
                y: { title: { display: true, text: 'actor_loss', font: { size: 9 } }, ticks: { font: { size: 8 } } }
              },
              plugins: { legend: { display: false }, tooltip: { enabled: true } }
            }
          })
        }
      }
    })
  }

  // Èä∑ÊØÄ NES Finetune ÂúñË°®
  function destroyNesFinetuneCharts() {
    if (nesFinetuneRewardChart.value) { nesFinetuneRewardChart.value.destroy(); nesFinetuneRewardChart.value = null }
    if (nesFinetuneCriticLossChart.value) { nesFinetuneCriticLossChart.value.destroy(); nesFinetuneCriticLossChart.value = null }
    if (nesFinetuneActorLossChart.value) { nesFinetuneActorLossChart.value.destroy(); nesFinetuneActorLossChart.value = null }
  }

  // Êõ¥Êñ∞ NES Finetune ÂúñË°®
  // IMPORTANT: Use spread operator to avoid Vue Proxy <-> Chart.js circular reactivity
  function updateNesFinetuneCharts() {
    const data = nesFinetuneData.value
    if (nesFinetuneRewardChart.value) {
      nesFinetuneRewardChart.value.data.labels = [...data.epochs]
      nesFinetuneRewardChart.value.data.datasets[0].data = [...data.rewards]
      nesFinetuneRewardChart.value.data.datasets[1].data = [...data.rewardsMA10]
      nesFinetuneRewardChart.value.data.datasets[2].data = [...data.bestRewards]
      nesFinetuneRewardChart.value.data.datasets[3].data = [...data.bestRewardsMA10]
      nesFinetuneRewardChart.value.update('none')
    }
    if (nesFinetuneCriticLossChart.value) {
      nesFinetuneCriticLossChart.value.data.labels = [...data.epochs]
      nesFinetuneCriticLossChart.value.data.datasets[0].data = [...data.criticLosses]
      nesFinetuneCriticLossChart.value.update('none')
    }
    if (nesFinetuneActorLossChart.value) {
      nesFinetuneActorLossChart.value.data.labels = [...data.epochs]
      nesFinetuneActorLossChart.value.data.datasets[0].data = [...data.actorLosses]
      nesFinetuneActorLossChart.value.update('none')
    }
  }

  // Ê®°Êì¨ NES Finetune Ë®ìÁ∑¥
  let nesFinetuneInterval: ReturnType<typeof setInterval> | null = null

  function simulateNesFinetuning() {
    if (nesFinetuneInterval) clearInterval(nesFinetuneInterval)

    let currentEpoch = 0
    const maxEpoch = 1000
    const stepSize = 10
    let bestReward = 0.7 // Finetune ÂæûËºÉÈ´òËµ∑ÈªûÈñãÂßã

    nesFinetuneInterval = setInterval(() => {
      if (currentEpoch >= maxEpoch) {
        if (nesFinetuneInterval) clearInterval(nesFinetuneInterval)
        nesFinetuneStatus.value = 'finish'
        nesFinetuneResults.value = { reward: 0.98, actorLoss: -2.3, criticLoss: 0.002 }
        return
      }

      currentEpoch += stepSize
      nesFinetuneEpoch.value = currentEpoch

      const progress = currentEpoch / maxEpoch
      const baseReward = 0.7 + (0.28 * progress) // Âæû 0.7 Â¢ûÈï∑Âà∞ 0.98
      const noise = (Math.random() - 0.5) * 0.1
      const currentReward = Math.max(0.6, Math.min(1.1, baseReward + noise))

      if (currentReward > bestReward) bestReward = currentReward

      const criticBase = 0.15 * Math.exp(-progress * 3)
      const criticNoise = Math.random() * 0.01
      const criticLoss = Math.max(0.002, criticBase + criticNoise)

      const actorBase = -1.5 - (0.5 * progress)
      const actorNoise = (Math.random() - 0.5) * 0.2
      const actorLoss = actorBase + actorNoise

      nesFinetuneData.value.epochs.push(currentEpoch)
      nesFinetuneData.value.rewards.push(currentReward)
      nesFinetuneData.value.bestRewards.push(bestReward)
      nesFinetuneData.value.criticLosses.push(criticLoss)
      nesFinetuneData.value.actorLosses.push(actorLoss)

      nesFinetuneData.value.rewardsMA10 = calculateMA(nesFinetuneData.value.rewards, 10)
      nesFinetuneData.value.bestRewardsMA10 = calculateMA(nesFinetuneData.value.bestRewards, 10)

      nesFinetuneResults.value = { reward: currentReward, actorLoss: actorLoss, criticLoss: criticLoss }

      updateNesFinetuneCharts()
    }, 50)
  }

  // ÂÅúÊ≠¢ NES Finetune Ë®ìÁ∑¥
  function stopNesFinetuning() {
    if (nesFinetuneInterval) {
      clearInterval(nesFinetuneInterval)
      nesFinetuneInterval = null
    }
    nesFinetuneStatus.value = 'idle'
    snackbar.value = { show: true, text: 'Finetune Ë®ìÁ∑¥Â∑≤ÂÅúÊ≠¢', color: 'info' }
  }

  // Êõ¥Êñ∞ NES Finetune Ê®°Âûã
  async function updateNesFinetuneModel() {
    if (!nesModelSelect.value) {
      snackbar.value = {
        show: true,
        text: 'Ë´ãÂÖàÈÅ∏ÊìáÊ®°ÂûãÁâàÊú¨',
        color: 'warning'
      }
      return
    }

    try {
      // Call App Control API to update the NES app (change version)
      const response = await updateApp({
        project_id: projectId.value || 'ED8F',
        app_id: 'NES',
        version_id: nesModelSelect.value
      })

      log.info('NES app updated:', response)

      snackbar.value = {
        show: true,
        text: `Finetune Ê®°ÂûãÂ∑≤Êõ¥Êñ∞Âà∞ ${nesModelSelect.value}ÔºåÂèØ‰ª• Enable`,
        color: 'success'
      }
    } catch (err) {
      log.error('Failed to update NES app:', err)
      snackbar.value = {
        show: true,
        text: `Êõ¥Êñ∞Â§±Êïó: ${appControlError.value || 'ÁÑ°Ê≥ïÈÄ£Êé•Âà∞Ë®àÁÆóÂπ≥Âè∞'}`,
        color: 'error'
      }
    }
  }

  // ÂïüÁî® NES Ê®°Âûã
  async function enableNesModel() {
    if (!nesModelSelect.value) {
      snackbar.value = {
        show: true,
        text: 'Ë´ãÂÖàÈÅ∏ÊìáÊ®°ÂûãÁâàÊú¨',
        color: 'warning'
      }
      return
    }

    try {
      // Call App Control API to enable the NES app
      const response = await enableApp({
        project_id: projectId.value || 'ED8F',
        app_id: 'NES',
        version_id: nesModelSelect.value
      })

      log.info('NES app enabled:', response)

      snackbar.value = {
        show: true,
        text: `NES Ê®°Âûã ${nesModelSelect.value} Â∑≤ÂïüÁî®`,
        color: 'success'
      }

      nesEnableMode.value = true
      nesDashboardMode.value = false
      nextTick(() => initNesEnableMap())
    } catch (err) {
      log.error('Failed to enable NES app:', err)
      snackbar.value = {
        show: true,
        text: `ÂïüÁî®Â§±Êïó: ${appControlError.value || 'ÁÑ°Ê≥ïÈÄ£Êé•Âà∞Ë®àÁÆóÂπ≥Âè∞'}`,
        color: 'error'
      }
    }
  }

  // È°ØÁ§∫ NES Dashboard (Figma 277:1561)
  function showNesDashboard() {
    nesDashboardMode.value = true
  }

  // Èö±Ëóè NES DashboardÔºåËøîÂõû Map UI
  function hideNesDashboard() {
    nesDashboardMode.value = false
  }

  // ÂàùÂßãÂåñ NES Enable Âú∞Âúñ
  async function initNesEnableMap() {
    if (nesEnableMap) {
      nesEnableMap.remove()
      nesEnableMap = null
    }

    // Ensure RU data is loaded
    await fetchRuData()

    await nextTick()
    const mapContainer = document.getElementById('nesEnableMap')
    if (!mapContainer) return

    try {
      mapboxgl.accessToken = mapAccessToken
      const initialStyle = (isOnline ? onlineStyle : offlineStyle) as string | mapboxgl.StyleSpecification | undefined

      nesEnableMap = new mapboxgl.Map({
        container: 'nesEnableMap',
        style: initialStyle,
        center: [120.9967, 24.787],
        zoom: 17
      })

      nesEnableMap.addControl(new mapboxgl.NavigationControl())

      nesEnableMap.on('load', () => {
        // Ê∑ªÂä† RU Ê®ôË®ò (‰ΩøÁî® ru.svg)
        const markers = ruMarkers.value.length > 0 ? ruMarkers.value : defaultRuMarkers
        markers.forEach(ru => {
          const el = document.createElement('div')
          el.className = 'ru-marker'
          el.style.width = '28px'
          el.style.height = '28px'
          el.style.backgroundImage = 'url(/img/ru.svg)'
          el.style.backgroundSize = 'contain'
          el.style.backgroundRepeat = 'no-repeat'
          el.title = ru.name
          new mapboxgl.Marker(el).setLngLat([ru.lng, ru.lat]).addTo(nesEnableMap!)
        })
        // Ê∑ªÂä† UE Ê®ôË®ò
        const uePositions = [[120.9965, 24.7875], [120.9975, 24.7865], [120.9980, 24.7880]]
        uePositions.forEach(pos => {
          const ueEl = document.createElement('div')
          ueEl.innerHTML = 'üë§'
          ueEl.style.fontSize = '18px'
          new mapboxgl.Marker(ueEl).setLngLat(pos as [number, number]).addTo(nesEnableMap!)
        })
      })
    } catch (error) {
      console.error('NES Enable map initialization error:', error)
    }
  }

  // ÈáçÊñ∞Ë®ìÁ∑¥ NES
  async function startNesRetrain() {
    // ÂÖàÂòóË©¶Âà™Èô§ÁèæÊúâÁöÑ NES ÊáâÁî®ÂØ¶‰æã
    if (nesModelSelect.value) {
      try {
        await deleteApp({
          project_id: projectId.value || 'ED8F',
          app_id: 'NES',
          version_id: nesModelSelect.value
        })
        log.info('Previous NES app deleted for re-train')
      } catch (err) {
        log.warn('Could not delete previous NES app (may not exist):', err)
      }
    }

    nesEnableMode.value = false
    nesDashboardMode.value = false
    nesPretrainDone.value = false
    nesFinetuneStatus.value = 'idle'
    nesFinetuneEpoch.value = 0
    resetNesFinetuneData()

    if (nesEnableMap) {
      nesEnableMap.remove()
      nesEnableMap = null
    }

    // ÈñãÂßãÊñ∞ÁöÑ Pre-train
    startTraining()
  }

  // ========== Positioning Model Ë®ìÁ∑¥ÊéßÂà∂ ==========

  // ÈñãÂßã Positioning È†êË®ìÁ∑¥ (Pre-train ÊåâÈàï)
  function startPosPretrain() {
    if (!posModelSelect.value) return
    snackbar.value = {
      show: true,
      text: 'Pre-train ÂäüËÉΩÂ∞öÊú™ÂØ¶‰Ωú (ÈúÄÂæåÁ´Ø API: POST /ai-simulator/positioning/pretrain/start)',
      color: 'warning'
    }
  }

  // ÈñãÂßã Positioning Ë®ìÁ∑¥ (START ÊåâÈàï)
  function startPosTraining() {
    if (!posModelSelect.value) {
      snackbar.value = {
        show: true,
        text: 'Ë´ãÂÖàÈÅ∏ÊìáÊ®°Âûã',
        color: 'warning'
      }
      return
    }

    posTrainingStatus.value = 'running'
    posTrainingEpoch.value = 0
    resetPosTrainingData()

    // ÂàùÂßãÂåñÂúñË°®
    nextTick(() => {
      initPosChart()
      nextTick(() => simulatePosTraining())
    })
  }

  // ÂÅúÊ≠¢ Positioning Ë®ìÁ∑¥
  function stopPosTraining() {
    if (posTrainingInterval) {
      clearInterval(posTrainingInterval)
      posTrainingInterval = null
    }
    posTrainingStatus.value = 'idle'
    snackbar.value = {
      show: true,
      text: 'Ë®ìÁ∑¥Â∑≤ÂÅúÊ≠¢',
      color: 'info'
    }
  }

  // Êõ¥Êñ∞ Positioning Ê®°Âûã
  function updatePosModel() {
    snackbar.value = {
      show: true,
      text: 'Update ÂäüËÉΩÂ∞öÊú™ÂØ¶‰Ωú (ÈúÄÂæåÁ´Ø API: POST /ai-simulator/positioning/pretrain/update)',
      color: 'warning'
    }
  }

  // È°ØÁ§∫ Positioning Review
  function showPosReview() {
    posReviewMode.value = true
    // ÂàùÂßãÂåñ Review Âú∞Âúñ
    nextTick(() => initReviewMap())
  }

  // ÈÄÄÂá∫ Review Ê®°Âºè
  function exitReviewMode() {
    posReviewMode.value = false
    posPathData.value = []
    if (reviewMap) {
      reviewMap.remove()
      reviewMap = null
    }
  }

  // ËôïÁêÜ Positioning BACK ÊåâÈàïÔºàÊ†πÊìöÁï∂ÂâçÊ®°ÂºèÊ±∫ÂÆöË°åÁÇ∫Ôºâ
  function handlePosBack() {
    // Â¶ÇÊûúÂú® Enable Ê®°ÂºèÔºåÈÄÄÂá∫ Enable
    if (posEnableMode.value) {
      posEnableMode.value = false
      if (enableMap) {
        enableMap.remove()
        enableMap = null
      }
      return
    }
    // Â¶ÇÊûúÂú® Review Ê®°ÂºèÔºåÈÄÄÂá∫ Review
    if (posReviewMode.value) {
      exitReviewMode()
      return
    }
    // Â¶ÇÊûúÂú® Finetune Ë®ìÁ∑¥‰∏≠ÔºåÂÅúÊ≠¢Ë®ìÁ∑¥
    if (posFinetuneStatus.value === 'running') {
      stopPosTraining()
      return
    }
    // Âê¶ÂâáËøîÂõû Model List
    goBack()
  }

  // Á¢∫Ë™ç Pre-train ÂÆåÊàêÔºåÈÄ≤ÂÖ• Finetune ÈöéÊÆµ
  function confirmPretrainDone() {
    posPretrainDone.value = true
    posTrainingStatus.value = 'idle'
    snackbar.value = {
      show: true,
      text: 'Pre-train ÂÆåÊàêÔºåÂèØ‰ª•ÈñãÂßã Finetune',
      color: 'success'
    }
  }

  // ÈáçÁΩÆ Finetune Ë®ìÁ∑¥Êï∏Êìö
  function resetFinetuneData() {
    posFinetuneData.value = {
      epochs: [],
      trainLosses: [],
      valLosses: []
    }
  }

  // ÈñãÂßã Finetune Ë®ìÁ∑¥
  // È°ØÁ§∫ Positioning Upload Â∞çË©±Ê°Ü (Figma 277:1070)
  function showPosUploadDialogFn() {
    posUploadDataset.value = null
    showPosUploadDialog.value = true
  }

  // Êèê‰∫§ Positioning Upload (ÈñãÂßã Finetune)
  function submitPosUpload() {
    if (!posUploadDataset.value) {
      snackbar.value = {
        show: true,
        text: 'Ë´ãÂÖàÈÅ∏ÊìáË®ìÁ∑¥Ë≥áÊñôÈõÜ',
        color: 'warning'
      }
      return
    }
    showPosUploadDialog.value = false
    startPosFinetune()
  }

  // ÂèñÊ∂à Positioning Upload
  function cancelPosUpload() {
    showPosUploadDialog.value = false
    posUploadDataset.value = null
  }

  // ÈñãÂßã Positioning Finetune Ë®ìÁ∑¥
  function startPosFinetune() {
    posFinetuneStatus.value = 'running'
    posFinetuneEpoch.value = 0
    resetFinetuneData()

    nextTick(() => {
      initFinetuneChart()
      nextTick(() => simulateFinetuneTraining())
    })
  }

  // ÂàùÂßãÂåñ Finetune ÂúñË°®
  function initFinetuneChart() {
    if (posFinetuneChart.value) {
      posFinetuneChart.value.destroy()
      posFinetuneChart.value = null
    }

    nextTick(() => {
      if (posFinetuneChartRef.value) {
        const ctx = posFinetuneChartRef.value.getContext('2d')
        if (ctx) {
          posFinetuneChart.value = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'training',
                  data: [],
                  borderColor: '#2196F3',
                  backgroundColor: 'transparent',
                  borderWidth: 2,
                  pointRadius: 0,
                  tension: 0.1
                },
                {
                  label: 'validation',
                  data: [],
                  borderColor: '#FF9800',
                  backgroundColor: 'transparent',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  pointRadius: 0,
                  tension: 0.1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              scales: {
                x: {
                  title: { display: true, text: 'epoch', font: { size: 10 } },
                  ticks: { font: { size: 9 }, maxTicksLimit: 6 }
                },
                y: {
                  title: { display: true, text: 'loss', font: { size: 10 } },
                  ticks: { font: { size: 9 } },
                  min: 0
                }
              },
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { font: { size: 10 }, boxWidth: 20, padding: 10 }
                },
                tooltip: { enabled: true, mode: 'index', intersect: false }
              }
            }
          })
        }
      }
    })
  }

  // Êõ¥Êñ∞ Finetune ÂúñË°®Êï∏Êìö
  // IMPORTANT: Use spread operator to avoid Vue Proxy <-> Chart.js circular reactivity
  function updateFinetuneChart() {
    const data = posFinetuneData.value
    if (posFinetuneChart.value) {
      posFinetuneChart.value.data.labels = [...data.epochs]
      posFinetuneChart.value.data.datasets[0].data = [...data.trainLosses]
      posFinetuneChart.value.data.datasets[1].data = [...data.valLosses]
      posFinetuneChart.value.update('none')
    }
  }

  // Ê®°Êì¨ Finetune Ë®ìÁ∑¥ÈÅéÁ®ã
  let finetuneInterval: ReturnType<typeof setInterval> | null = null

  function simulateFinetuneTraining() {
    if (finetuneInterval) clearInterval(finetuneInterval)

    let currentEpoch = 0
    const maxEpoch = 500
    const stepSize = 5

    finetuneInterval = setInterval(() => {
      if (currentEpoch >= maxEpoch) {
        if (finetuneInterval) clearInterval(finetuneInterval)
        posFinetuneStatus.value = 'finish'
        posFinetuneResults.value = {
          trainLoss: 0.08,
          valLoss: 0.12
        }
        return
      }

      currentEpoch += stepSize
      posFinetuneEpoch.value = currentEpoch

      // Finetune ÁöÑ loss ÂæûËºÉ‰ΩéÂÄºÈñãÂßãÔºàÂõ†ÁÇ∫Â∑≤Á∂ì Pre-train ÈÅéÔºâ
      const progress = currentEpoch / maxEpoch
      const trainBase = 0.25 * Math.exp(-progress * 3)
      const trainNoise = Math.random() * 0.02
      const trainLoss = Math.max(0.08, trainBase + trainNoise)

      const valBase = 0.30 * Math.exp(-progress * 2.5)
      const valNoise = Math.random() * 0.03
      const valLoss = Math.max(0.10, valBase + valNoise)

      posFinetuneData.value.epochs.push(currentEpoch)
      posFinetuneData.value.trainLosses.push(trainLoss)
      posFinetuneData.value.valLosses.push(valLoss)

      posFinetuneResults.value = {
        trainLoss: trainLoss,
        valLoss: valLoss
      }

      updateFinetuneChart()
    }, 50)
  }

  // ÂïüÁî®Ê®°ÂûãÔºàEnableÔºâ‰∏¶È°ØÁ§∫ Project Ë¶ñÂúñ
  function enablePosModel() {
    posEnableMode.value = true
    nextTick(() => initEnableMap())
  }

  // ÂàùÂßãÂåñ Enable Ê®°ÂºèÂú∞Âúñ
  async function initEnableMap() {
    if (enableMap) {
      enableMap.remove()
      enableMap = null
    }

    await nextTick()
    const mapContainer = document.getElementById('posEnableMap')
    if (!mapContainer) return

    try {
      mapboxgl.accessToken = mapAccessToken
      const initialStyle = (isOnline ? onlineStyle : offlineStyle) as string | mapboxgl.StyleSpecification | undefined

      enableMap = new mapboxgl.Map({
        container: 'posEnableMap',
        style: initialStyle,
        center: [120.997, 24.787],
        zoom: 17
      })

      enableMap.addControl(new mapboxgl.NavigationControl())

      // Âú∞ÂúñËºâÂÖ•ÂÆåÊàêÂæåÊ∑ªÂä†Ê®ôË®ò
      enableMap.on('load', () => {
        // Ê∑ªÂä† gNB Ê®ôË®ò
        const gnbEl = document.createElement('div')
        gnbEl.innerHTML = 'üì∂'
        gnbEl.style.fontSize = '24px'
        new mapboxgl.Marker(gnbEl)
          .setLngLat([120.997, 24.787])
          .addTo(enableMap!)

        // Ê∑ªÂä†Ê®°Êì¨ UE Ê®ôË®ò
        const uePositions = [
          [120.9965, 24.7875],
          [120.9975, 24.7865],
          [120.9980, 24.7880]
        ]
        uePositions.forEach(pos => {
          const ueEl = document.createElement('div')
          ueEl.innerHTML = 'üë§'
          ueEl.style.fontSize = '20px'
          new mapboxgl.Marker(ueEl)
            .setLngLat(pos as [number, number])
            .addTo(enableMap!)
        })
      })
    } catch (error) {
      console.error('Enable map initialization error:', error)
    }
  }

  // ÈáçÊñ∞Ë®ìÁ∑¥ÔºàRe-trainÔºâ
  function startPosRetrain() {
    // ÈáçÁΩÆÊâÄÊúâÁãÄÊÖãÂõûÂà∞ Pre-train ÈöéÊÆµ
    posEnableMode.value = false
    posPretrainDone.value = false
    posFinetuneStatus.value = 'idle'
    posFinetuneEpoch.value = 0
    resetFinetuneData()

    if (enableMap) {
      enableMap.remove()
      enableMap = null
    }

    // ÈñãÂßãÊñ∞ÁöÑË®ìÁ∑¥
    startPosTraining()
  }

  // ÂàùÂßãÂåñ Review Âú∞Âúñ
  async function initReviewMap() {
    if (reviewMap) {
      reviewMap.remove()
      reviewMap = null
    }

    await nextTick()
    const mapContainer = document.getElementById('posReviewMap')
    if (!mapContainer) return

    try {
      mapboxgl.accessToken = mapAccessToken
      const initialStyle = (isOnline ? onlineStyle : offlineStyle) as string | mapboxgl.StyleSpecification | undefined

      reviewMap = new mapboxgl.Map({
        container: 'posReviewMap',
        style: initialStyle,
        center: [120.997, 24.787],
        zoom: 17
      })

      reviewMap.addControl(new mapboxgl.NavigationControl())

      // Âú∞ÂúñËºâÂÖ•ÂÆåÊàêÂæåÁπ™Ë£ΩË∑ØÂæë
      reviewMap.on('load', () => {
        drawPathsOnMap()
      })
    } catch (error) {
      console.error('Review map initialization error:', error)
    }
  }

  // Ê∑ªÂä†Ë∑ØÂæë
  function addPath() {
    // ÁîüÊàêÊ®°Êì¨Ë∑ØÂæëÊï∏Êìö
    const pathId = posPathData.value.length + 1
    const basePoints = generateSimulatedPath()

    posPathData.value.push({
      id: pathId,
      points: basePoints,
      uePosition: basePoints[basePoints.length - 1]
    })

    // Âú®Âú∞Âúñ‰∏äÁπ™Ë£ΩË∑ØÂæë
    if (reviewMap && reviewMap.loaded()) {
      drawPathsOnMap()
    }

    snackbar.value = {
      show: true,
      text: `Â∑≤Ê∑ªÂä†Ë∑ØÂæë ${pathId}`,
      color: 'success'
    }
  }

  // ÁîüÊàêÊ®°Êì¨Ë∑ØÂæë
  function generateSimulatedPath(): PathPoint[] {
    const centerLng = 120.997
    const centerLat = 24.787
    const pathLength = 8 + Math.floor(Math.random() * 5)
    const points: PathPoint[] = []

    // Èö®Ê©üËµ∑Èªû
    let lng = centerLng + (Math.random() - 0.5) * 0.003
    let lat = centerLat + (Math.random() - 0.5) * 0.002

    for (let i = 0; i < pathLength; i++) {
      points.push({ lng, lat })
      // Èö®Ê©üÊñπÂêëÁßªÂãï
      lng += (Math.random() - 0.5) * 0.0008
      lat += (Math.random() - 0.5) * 0.0005
    }

    return points
  }

  // Âú®Âú∞Âúñ‰∏äÁπ™Ë£ΩË∑ØÂæë
  function drawPathsOnMap() {
    if (!reviewMap) return

    // ÁßªÈô§ËàäÁöÑË∑ØÂæëÂúñÂ±§ÂíåÊï∏ÊìöÊ∫ê
    posPathData.value.forEach((_, index) => {
      const sourceId = `path-source-${index}`
      const lineLayerId = `path-line-${index}`
      const pointLayerId = `path-points-${index}`

      if (reviewMap!.getLayer(lineLayerId)) {
        reviewMap!.removeLayer(lineLayerId)
      }
      if (reviewMap!.getLayer(pointLayerId)) {
        reviewMap!.removeLayer(pointLayerId)
      }
      if (reviewMap!.getSource(sourceId)) {
        reviewMap!.removeSource(sourceId)
      }
    })

    // Áπ™Ë£ΩÊØèÊ¢ùË∑ØÂæë
    posPathData.value.forEach((path, index) => {
      const sourceId = `path-source-${index}`
      const lineLayerId = `path-line-${index}`

      // Ê∑ªÂä†Ë∑ØÂæëÁ∑öÊï∏ÊìöÊ∫ê
      reviewMap!.addSource(sourceId, {
        type: 'geojson',
        data: {
          type: 'Feature',
          properties: {},
          geometry: {
            type: 'LineString',
            coordinates: path.points.map(p => [p.lng, p.lat])
          }
        }
      })

      // Ê∑ªÂä†Ë∑ØÂæëÁ∑öÂúñÂ±§
      reviewMap!.addLayer({
        id: lineLayerId,
        type: 'line',
        source: sourceId,
        layout: {
          'line-join': 'round',
          'line-cap': 'round'
        },
        paint: {
          'line-color': '#FF6B00',
          'line-width': 3
        }
      })

      // Ê∑ªÂä† UE Ê®ôË®ò
      const ueEl = document.createElement('div')
      ueEl.className = 'ue-marker'
      ueEl.style.width = '12px'
      ueEl.style.height = '12px'
      ueEl.style.backgroundColor = '#FF0000'
      ueEl.style.borderRadius = '50%'
      ueEl.style.border = '2px solid white'

      new mapboxgl.Marker(ueEl)
        .setLngLat([path.uePosition.lng, path.uePosition.lat])
        .addTo(reviewMap!)
    })
  }

  // Ê®°Êì¨Ë®ìÁ∑¥ÈÅéÁ®ã - ÁîüÊàêÈ°û‰ºº Figma Ë®≠Ë®àÁöÑÊï∏Êìö
  let trainingInterval: ReturnType<typeof setInterval> | null = null
  let posTrainingInterval: ReturnType<typeof setInterval> | null = null

  function simulateTraining() {
    if (trainingInterval) clearInterval(trainingInterval)

    // Ë®ìÁ∑¥ÂèÉÊï∏
    let currentEpoch = 0
    const maxEpoch = 1000
    const stepSize = 10 // ÊØèÊ¨°Êõ¥Êñ∞ÁöÑ epoch Êï∏
    let bestReward = 0.5

    trainingInterval = setInterval(() => {
      if (currentEpoch >= maxEpoch) {
        if (trainingInterval) clearInterval(trainingInterval)
        trainingStatus.value = 'finish'
        trainingResults.value = {
          reward: 0.98,
          actorLoss: -2.3,
          criticLoss: 0.002
        }
        return
      }

      currentEpoch += stepSize
      trainingEpoch.value = currentEpoch

      // Ê®°Êì¨ Reward Êï∏Êìö (ÈÄêÊº∏Âæû 0.5 Â¢ûÈï∑Âà∞ 0.98ÔºåÂ∏∂Èö®Ê©üÊ≥¢Âãï)
      const progress = currentEpoch / maxEpoch
      const baseReward = 0.5 + (0.48 * progress)
      const noise = (Math.random() - 0.5) * 0.15
      const currentReward = Math.max(0.4, Math.min(1.1, baseReward + noise))

      // Êõ¥Êñ∞ best reward
      if (currentReward > bestReward) {
        bestReward = currentReward
      }

      // Critic Loss: Âæû 0.35 ‰∏ãÈôçÂà∞ 0.002 (Âø´ÈÄü‰∏ãÈôçÂæåË∂®ÊñºÂπ≥Á©©)
      const criticBase = 0.35 * Math.exp(-progress * 3)
      const criticNoise = Math.random() * 0.02
      const criticLoss = Math.max(0.002, criticBase + criticNoise)

      // Actor Loss: Âæû -1.2 ‰∏ãÈôçÂà∞ -2.0 (Â∏∂ËºÉÂ§ßÊ≥¢Âãï)
      const actorBase = -1.2 - (0.8 * progress)
      const actorNoise = (Math.random() - 0.5) * 0.3
      const actorLoss = actorBase + actorNoise

      // Â≠òÂÑ≤Êï∏Êìö
      trainingData.value.epochs.push(currentEpoch)
      trainingData.value.rewards.push(currentReward)
      trainingData.value.bestRewards.push(bestReward)
      trainingData.value.criticLosses.push(criticLoss)
      trainingData.value.actorLosses.push(actorLoss)

      // Ë®àÁÆóÁßªÂãïÂπ≥Âùá
      trainingData.value.rewardsMA10 = calculateMA(trainingData.value.rewards, 10)
      trainingData.value.bestRewardsMA10 = calculateMA(trainingData.value.bestRewards, 10)

      // Êõ¥Êñ∞È°ØÁ§∫ÁµêÊûú
      trainingResults.value = {
        reward: currentReward,
        actorLoss: actorLoss,
        criticLoss: criticLoss
      }

      // Êõ¥Êñ∞ÂúñË°®
      updateCharts()
    }, 50) // 50ms Êõ¥Êñ∞‰∏ÄÊ¨°ÔºåËÆìÂãïÁï´ÊµÅÊö¢
  }

  // Ê®°Êì¨ Positioning Ë®ìÁ∑¥ÈÅéÁ®ã - MSE LossÔºå500 epochs
  function simulatePosTraining() {
    if (posTrainingInterval) clearInterval(posTrainingInterval)

    let currentEpoch = 0
    const maxEpoch = 500
    const stepSize = 5

    posTrainingInterval = setInterval(() => {
      if (currentEpoch >= maxEpoch) {
        if (posTrainingInterval) clearInterval(posTrainingInterval)
        posTrainingStatus.value = 'finish'
        posTrainingResults.value = {
          trainLoss: 0.0012,
          valLoss: 0.0018
        }
        return
      }

      currentEpoch += stepSize
      posTrainingEpoch.value = currentEpoch

      // Ê®°Êì¨ MSE Loss ‰∏ãÈôçÊõ≤Á∑ö
      const progress = currentEpoch / maxEpoch
      // Training loss: Âæû 0.5 ‰∏ãÈôçÂà∞ 0.001 (ÊåáÊï∏Ë°∞Ê∏õ)
      const trainBase = 0.5 * Math.exp(-progress * 4)
      const trainNoise = Math.random() * 0.01
      const trainLoss = Math.max(0.001, trainBase + trainNoise)

      // Validation loss: ÊØî training Á®çÈ´òÔºåÊúâÊõ¥Â§öÊ≥¢Âãï
      const valBase = 0.55 * Math.exp(-progress * 3.5)
      const valNoise = Math.random() * 0.02
      const valLoss = Math.max(0.0015, valBase + valNoise)

      // Â≠òÂÑ≤Êï∏Êìö
      posTrainingData.value.epochs.push(currentEpoch)
      posTrainingData.value.trainLosses.push(trainLoss)
      posTrainingData.value.valLosses.push(valLoss)

      // Êõ¥Êñ∞È°ØÁ§∫ÁµêÊûú
      posTrainingResults.value = {
        trainLoss: trainLoss,
        valLoss: valLoss
      }

      // Êõ¥Êñ∞ÂúñË°®
      updatePosChart()
    }, 50)
  }

  // ÂàùÂßãÂåñÂú∞Âúñ
  const initializeMap = async () => {
    if (map) {
      map.remove()
      map = null
    }

    await nextTick()
    const mapContainer = document.getElementById('aiSimulatorMap')
    if (!mapContainer) return

    try {
      mapboxgl.accessToken = mapAccessToken
      const initialStyle = (isOnline ? onlineStyle : offlineStyle) as string | mapboxgl.StyleSpecification | undefined

      map = new mapboxgl.Map({
        container: 'aiSimulatorMap',
        style: initialStyle,
        center: [120.997, 24.787], // ‰∫§Â§ßÂ∫ßÊ®ô
        zoom: 16
      })
      map.addControl(new mapboxgl.NavigationControl())
    } catch (error) {
      console.error('Map initialization error:', error)
    }
  }

  // Áõ£ËÅΩË®ìÁ∑¥ÁãÄÊÖãÔºåÈáçÊñ∞ÂàùÂßãÂåñÂú∞Âúñ
  watch([trainingStatus, posTrainingStatus], ([nesStatus, posStatus]) => {
    // Áï∂ÊâÄÊúâË®ìÁ∑¥ÈÉΩÂÅúÊ≠¢ÊôÇÔºåÈáçÊñ∞ÂàùÂßãÂåñÂú∞Âúñ
    if (nesStatus === 'idle' && posStatus === 'idle') {
      destroyCharts()
      nextTick(() => initializeMap())
    }
  })

  onMounted(() => {
    log.lifecycle('mounted')
    log.mapInit('Initializing main map')
    initializeMap()
  })

  onUnmounted(() => {
    log.lifecycle('unmounting')

    // Clean up remote resources first (stop polling before destroying UI)
    stopStatusPolling()
    stopResultsPolling()
    stopMongoDBResultsSync()

    if (map) {
      map.remove()
      map = null
    }
    if (reviewMap) {
      reviewMap.remove()
      reviewMap = null
    }
    if (enableMap) {
      enableMap.remove()
      enableMap = null
    }
    if (nesReviewMap) {
      nesReviewMap.remove()
      nesReviewMap = null
    }
    if (nesEnableMap) {
      nesEnableMap.remove()
      nesEnableMap = null
    }
    if (trainingInterval) {
      clearInterval(trainingInterval)
    }
    if (posTrainingInterval) {
      clearInterval(posTrainingInterval)
    }
    if (finetuneInterval) {
      clearInterval(finetuneInterval)
    }
    if (nesFinetuneInterval) {
      clearInterval(nesFinetuneInterval)
    }
    destroyCharts()
    destroyNesFinetuneCharts()
    log.lifecycle('unmounted')
  })
</script>

<style scoped>
.ai-simulator-page {
  padding: 24px;
  max-width: 1440px;
  margin: 0 auto;
}

.page-header {
  display: flex;
  align-items: center;
  gap: 24px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.page-title {
  font-size: 40px;
  font-weight: 400;
  color: #000;
  margin: 0;
}

/* Ë≠¶ÂëäÊ©´ÂπÖ (Figma 277:986) */
.warning-banner {
  display: flex;
  align-items: center;
  gap: 8px;
  border: 1px solid rgba(185, 7, 7, 0.5);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 16px;
  color: rgba(255, 0, 0, 0.7);
}

.page-content {
  display: flex;
  gap: 24px;
  min-height: 700px;
}

/* Â∑¶ÂÅ¥Èù¢Êùø - Ëàá ai-ran ‰øùÊåÅ‰∏ÄËá¥ */
.left-panel {
  width: 180px;
  flex-shrink: 0;
  background: #fff;
  border: 2px solid #000;
  border-radius: 12px;
  padding: 16px;
  display: flex;
  flex-direction: column;
}

.panel-header {
  font-size: 18px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 16px;
  color: #333;
}

.model-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.model-btn {
  width: 100%;
  height: 44px;
  font-size: 14px !important;
  font-weight: 500;
  text-transform: none;
  border-radius: 20px !important;
}

/* NES ÊéßÂà∂Èù¢Êùø - Ëàá ai-ran ‰øùÊåÅ‰∏ÄËá¥ */
.nes-controls,
.positioning-controls {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 12px 16px;
}

.model-select {
  margin-bottom: 4px;
  max-width: 180px;
  flex-shrink: 0;
}

/* Training Parameters Input Section */
.training-params {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin: 8px 0;
  padding: 8px;
  background: rgba(0, 0, 0, 0.03);
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.08);
}

.param-input {
  max-width: 180px;
}

.param-input :deep(.v-field__input) {
  font-size: 13px;
  padding: 4px 8px;
}

/* FL Task Status Badge */
.fl-status-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 6px 12px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 500;
  margin: 8px 0;
  max-width: 180px;
}

.fl-status-badge.running {
  background: linear-gradient(135deg, #4CAF50, #8BC34A);
  color: white;
  animation: pulse 2s infinite;
}

.fl-status-badge.waiting {
  background: linear-gradient(135deg, #FF9800, #FFC107);
  color: white;
}

.fl-status-badge.not\ in\ queue {
  background: linear-gradient(135deg, #9E9E9E, #BDBDBD);
  color: white;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Developer Mode Panel (hidden feature - activated by 10 clicks on title) */
.dev-mode-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  width: 320px;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border: 1px solid #00BCD4;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 188, 212, 0.3);
  z-index: 1000;
  font-family: 'Fira Code', 'Consolas', monospace;
  color: #e0e0e0;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.dev-mode-header {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: rgba(0, 188, 212, 0.15);
  border-bottom: 1px solid rgba(0, 188, 212, 0.3);
  font-size: 13px;
  font-weight: 600;
  color: #00BCD4;
}

.dev-mode-header .v-btn {
  margin-left: auto;
}

.dev-mode-content {
  padding: 16px;
}

.status-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 6px;
}

.status-item .label {
  font-size: 12px;
  color: #9e9e9e;
}

.status-item .value {
  font-size: 13px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 4px;
}

.status-item .value.idle { background: #607D8B; color: white; }
.status-item .value.startflowerapp { background: #4CAF50; color: white; }
.status-item .value.termination { background: #FF9800; color: white; }
.status-item .value.internalerror { background: #F44336; color: white; }
.status-item .value.nullstate { background: #9E9E9E; color: white; }
.status-item .value.error { background: #F44336; color: white; }
.status-item .value.unreachable { background: #795548; color: white; }
.status-item .value.active { background: #4CAF50; color: white; }
.status-item .value.inactive { background: #9E9E9E; color: white; }
.status-item .value.final { background: #2196F3; color: white; }
.status-item .value.not-final { background: #FF9800; color: white; }

.status-loading {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  font-size: 13px;
  color: #9e9e9e;
}

.control-btn {
  max-width: 180px;
  height: 40px;
  font-size: 13px !important;
  font-weight: 500;
  text-transform: none;
  border-radius: 20px !important;
}

.retrain-btn {
  border: 2px solid #1976d2;
  background: transparent !important;
  color: #1976d2 !important;
}

.panel-actions {
  display: flex;
  gap: 8px;
  margin-top: auto;
  padding-top: 16px;
}

.action-btn {
  flex: 1;
  height: 36px;
  min-width: 70px;
  max-width: 90px;
  font-size: 12px !important;
  text-transform: none;
  border-radius: 18px !important;
}

.start-btn {
  background: #333 !important;
}

/* Placeholder ÂÖßÂÆπ - Ëàá ai-ran ‰øùÊåÅ‰∏ÄËá¥ */
.placeholder-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #999;
}

/* Âè≥ÂÅ¥Èù¢Êùø - Ëàá ai-ran ‰øùÊåÅ‰∏ÄËá¥ */
.right-panel {
  flex: 1;
  background: #fff;
  border: 2px solid #000;
  border-radius: 12px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Âú∞ÂúñÂÆπÂô® */
.map-container {
  flex: 1;
  position: relative;
  min-height: 500px;
}

.map-view {
  width: 100%;
  height: 100%;
  min-height: 500px;
}

/* Ëâ≤Ê®ô */
.color-bar {
  position: absolute;
  right: 20px;
  top: 100px;
  width: 45px;
  height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.color-gradient {
  width: 24px;
  height: 250px;
  background: linear-gradient(to bottom, red, orange, yellow, green, cyan, blue);
  border-radius: 4px;
}

.color-labels {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  height: 250px;
  font-size: 11px;
  color: #333;
  position: absolute;
  right: 50px;
  top: 0;
}

/* Heatmap ÊéßÂà∂ */
.heatmap-control {
  position: absolute;
  right: 20px;
  bottom: 20px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.heatmap-switch {
  transform: scale(0.85);
}

.heatmap-select {
  max-width: 100px;
}

/* Ë®ìÁ∑¥ÁãÄÊÖã */
.training-status {
  font-size: 20px;
  margin-left: auto;
}

.training-status.running {
  color: #f00;
}

.training-status.finish {
  color: #4caf50;
}

/* Ë®ìÁ∑¥ÂÖßÂÆπ */
.training-content {
  display: flex;
  flex: 1;
  padding: 20px;
  gap: 24px;
}

.charts-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-width: 0;
}

.chart-container {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 12px;
}

.main-chart {
  flex: 2;
}

.chart-title {
  font-size: 12px;
  color: #333;
  margin-bottom: 8px;
  text-align: center;
  font-weight: 500;
}

.chart-wrapper {
  height: 240px;
  position: relative;
}

.chart-wrapper.small {
  height: 150px;
}

/* Positioning ÂúñË°®Ê®£Âºè */
.pos-chart {
  flex: 1;
}

.pos-wrapper {
  height: 400px;
}

.charts-row {
  display: flex;
  gap: 16px;
  flex: 1;
}

.charts-row .chart-container {
  flex: 1;
  min-width: 0;
}

/* Ë®ìÁ∑¥Ë≥áË®ä */
.training-info {
  width: 280px;
  padding: 16px;
  flex-shrink: 0;
}

.info-item {
  font-size: 18px;
  margin-bottom: 8px;
}

.info-item.highlight {
  color: #006ab5;
  font-size: 20px;
}

.results-section {
  margin-top: 24px;
}

.results-title {
  font-size: 18px;
  font-weight: 500;
  margin-bottom: 12px;
}

.result-item {
  font-size: 16px;
  margin-bottom: 8px;
  padding-left: 16px;
}

/* Review Ê®°Âºè (Figma 277:599, 277:652, 277:702) */
.review-content {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.review-map-container {
  flex: 1;
  position: relative;
  min-height: 500px;
}

.review-map {
  width: 100%;
  height: 100%;
  min-height: 500px;
}

.add-path-btn {
  position: absolute;
  left: 20px;
  top: 20px;
  z-index: 10;
  border-radius: 20px !important;
  text-transform: none;
  font-weight: 500;
}

.path-legend {
  position: absolute;
  left: 20px;
  top: 70px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
  padding: 10px 14px;
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.legend-dot {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.legend-dot.ue {
  background-color: #FF0000;
}

.legend-arrow {
  color: #FF6B00;
  font-size: 16px;
  font-weight: bold;
}

/* Enable Ê®°Âºè (Figma 277:1190) */
.enable-content {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.enable-map-container {
  flex: 1;
  position: relative;
  min-height: 500px;
}

.enable-map {
  width: 100%;
  height: 100%;
  min-height: 500px;
}

.enable-legend {
  position: absolute;
  left: 20px;
  top: 20px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
  padding: 10px 14px;
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.enable-controls {
  position: absolute;
  right: 20px;
  bottom: 20px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.signal-select {
  max-width: 100px;
}

/* Finetune Ê®ôÈ°åÊ®£Âºè */
.finetune-title {
  color: #006ab5;
  font-weight: 600;
}

/* Ë®ìÁ∑¥Ë≥áË®äÂ§ßÂ≠óÈ´î */
.info-item.large {
  font-size: 28px;
  font-weight: 500;
  margin-bottom: 16px;
}

.result-item.large {
  font-size: 24px;
  font-weight: 500;
  margin-bottom: 12px;
}

/* NES Review Ê®°Âºè (Figma 277:1286, 277:296) */
.nes-review-content {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.nes-review-map-container {
  flex: 1;
  position: relative;
  min-height: 500px;
}

.nes-review-map {
  width: 100%;
  height: 100%;
  min-height: 500px;
}

.scenario-select {
  position: absolute;
  left: 20px;
  top: 20px;
  z-index: 10;
  background: white;
  max-width: 150px;
  border-radius: 4px;
}

.nes-review-legend {
  position: absolute;
  right: 20px;
  top: 20px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
  padding: 10px 14px;
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.legend-icon {
  font-size: 16px;
}

/* Upload Â∞çË©±Ê°ÜÊ®£Âºè (Figma 277:510, 277:1405) */
.upload-dialog {
  border-radius: 12px;
  padding: 8px;
}

.upload-dialog-title {
  font-size: 18px;
  font-weight: 500;
  padding: 16px 20px 8px;
}

.upload-dialog-content {
  padding: 12px 20px 20px;
}

.upload-dialog-actions {
  padding: 8px 20px 16px;
  gap: 12px;
}

.dialog-btn {
  min-width: 80px;
  border-radius: 8px !important;
  text-transform: none;
}

.dataset-select {
  margin-top: 8px;
}

/* NES Finetune idle ÁãÄÊÖãÊ®£Âºè */
.finetune-idle-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  padding: 40px;
}

.idle-text {
  font-size: 24px;
  color: #666;
  text-align: center;
}

/* Dashboard ÊåâÈàï (Figma 277:1526) */
.dashboard-btn {
  position: absolute;
  top: 20px;
  right: 100px;
  z-index: 10;
  border-radius: 4px !important;
  text-transform: none;
  font-weight: 500;
}

.map-ui-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 10;
  border-radius: 4px !important;
  text-transform: none;
  font-weight: 500;
}

/* Dashboard ÂÖßÂÆπ (Figma 277:1561) */
.dashboard-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
  background: #1a1a2e;
  padding: 20px;
  overflow: auto;
}

.dashboard-panel {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 50px;
}

.dashboard-stats {
  display: flex;
  gap: 16px;
}

.stat-card {
  padding: 16px 24px;
  border-radius: 8px;
  min-width: 150px;
}

.stat-card.num-ues {
  background: #2196F3;
  color: white;
}

.stat-card.throughput {
  background: #f44336;
  color: white;
}

.stat-label {
  font-size: 12px;
  opacity: 0.9;
}

.stat-value {
  font-size: 36px;
  font-weight: 600;
}

.stat-unit {
  font-size: 14px;
  font-weight: 400;
}

.dashboard-row {
  display: flex;
  gap: 16px;
}

.energy-gauge {
  background: #2d2d44;
  border-radius: 8px;
  padding: 16px;
  min-width: 150px;
  text-align: center;
}

.gauge-label {
  font-size: 12px;
  color: #aaa;
  margin-bottom: 8px;
}

.gauge-value {
  font-size: 28px;
  color: #4CAF50;
  font-weight: 600;
}

.gauge-unit {
  font-size: 14px;
  color: #aaa;
}

.radio-power {
  background: #2d2d44;
  border-radius: 8px;
  padding: 16px;
  flex: 1;
}

.power-label {
  font-size: 12px;
  color: #aaa;
  margin-bottom: 12px;
}

.power-bars {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  height: 60px;
}

.power-bar-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.power-bar {
  width: 24px;
  min-height: 4px;
  border-radius: 2px;
  transition: height 0.3s;
}

.power-value {
  font-size: 10px;
  color: #aaa;
}

.dashboard-charts {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.chart-placeholder {
  background: #2d2d44;
  border-radius: 8px;
  padding: 16px;
  min-height: 120px;
}

.chart-placeholder .chart-title {
  font-size: 12px;
  color: #aaa;
  margin-bottom: 8px;
}

.chart-placeholder .chart-area {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 80px;
  color: #666;
  font-size: 12px;
  border: 1px dashed #444;
  border-radius: 4px;
}

/* ÈüøÊáâÂºè */
@media (max-width: 1024px) {
  .page-content {
    flex-direction: column;
  }

  .left-panel {
    width: 100%;
  }

  .model-buttons {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
  }

  .model-btn {
    width: auto;
    min-width: 100px;
  }

  .training-content {
    flex-direction: column;
  }

  .training-info {
    width: 100%;
  }
}

@media (max-width: 768px) {
  .page-title {
    font-size: 28px;
  }

  .panel-header {
    font-size: 24px;
  }

  .charts-row {
    flex-direction: column;
  }
}
</style>

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ ç¡¬é«”åŠ é€Ÿ Dockerfile - Intel i9-9900KF + 64GB RAM å„ªåŒ–ç‰ˆ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# å„ªåŒ–ç‰¹æ€§:
# - Multi-stage build æ¸›å°‘ image å¤§å°
# - ä¸¦è¡Œ pip install (--jobs=8)
# - Gunicorn 12 workers * 2 threads = 24 concurrent requests
# - ä½¿ç”¨ slim base image
#
# ä½¿ç”¨æ–¹å¼:
#   nerdctl build -f Dockerfile.turbo -t wisdon-backend:turbo .
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Stage 1: Builder - å®‰è£ä¾è³´
FROM python:3.10-slim as builder

WORKDIR /app

# å®‰è£ç·¨è­¯å·¥å…· (å¦‚æœéœ€è¦ç·¨è­¯ C extensions)
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# è¤‡è£½ä¸¦å®‰è£ä¾è³´ (ä½¿ç”¨ä¸¦è¡Œå®‰è£åŠ é€Ÿ)
COPY requirement.txt /app/
RUN pip install --no-cache-dir --user -r requirement.txt

# Stage 2: Runtime - ç²¾ç°¡åŸ·è¡Œç’°å¢ƒ
FROM python:3.10-slim as runtime

WORKDIR /app

# å¾ builder è¤‡è£½å·²å®‰è£çš„å¥—ä»¶
COPY --from=builder /root/.local /root/.local
ENV PATH=/root/.local/bin:$PATH

# è¤‡è£½æ‡‰ç”¨ç¨‹å¼ç¢¼
COPY . /app/

# å‰µå»ºå¿…è¦ç›®éŒ„
RUN mkdir -p ./img && chmod -R 777 ./img && \
    mkdir -p /tmp/prometheus && chmod -R 777 /tmp/prometheus

# ç’°å¢ƒè®Šæ•¸
ENV FLASK_RUN_HOST=0.0.0.0
ENV FLASK_APP=app.py
ENV DEBIAN_FRONTEND=noninteractive
ENV PROMETHEUS_MULTIPROC_DIR=/tmp/prometheus
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

EXPOSE 2980

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Gunicorn ç¡¬é«”åŠ é€Ÿé…ç½® (Intel i9-9900KF å„ªåŒ–)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Workers è¨ˆç®—: 2 * CPU_CORES + 1 = 2 * 8 + 1 = 17
# ä½†ç‚ºäº†ç©©å®šæ€§å’Œ Memory è€ƒé‡ï¼Œä½¿ç”¨ 12 workers
#
# Threads per worker: 2 (gthread worker class)
# ç¸½ä¸¦ç™¼: 12 * 2 = 24 concurrent requests
#
# å…¶ä»–å„ªåŒ–:
# - --keep-alive 5: ä¿æŒé€£ç·š 5 ç§’æ¸›å°‘ TCP æ¡æ‰‹
# - --max-requests 10000: æ¯ 10000 requests é‡å•Ÿ worker é˜²æ­¢ memory leak
# - --max-requests-jitter 1000: éš¨æ©Ÿåç§»é˜²æ­¢åŒæ™‚é‡å•Ÿ
# - --graceful-timeout 30: å„ªé›…é—œé–‰è¶…æ™‚
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CMD ["gunicorn", \
     "-w", "12", \
     "--threads", "2", \
     "-b", "0.0.0.0:2980", \
     "config:app", \
     "--worker-class=gthread", \
     "--timeout", "120", \
     "--keep-alive", "5", \
     "--max-requests", "10000", \
     "--max-requests-jitter", "1000", \
     "--graceful-timeout", "30", \
     "--access-logfile", "-", \
     "--error-logfile", "-", \
     "--capture-output"]

{% extends "base.html" %} {% block style %}
<style>
  body {
    height: 100vh;
    color: #000000;
  }
  .title {
    color: #ffffff;
    margin: 2em 0 1.5em;
  }
  .form-floating > label::after {
    background-color: transparent !important;
  }
</style>
{% endblock %} {% block nav %}
<nav></nav>
{% endblock %} {% block content %}
<section style="text-align: center">
  <p class="title">Register</p>

  <form method="post" action="{{ url_for('register') }}">
    <div class="container">
      <div class="row mb-3 justify-content-center">
        <div class="col-4">
          <div class="form-floating">
            <input
              type="text"
              class="form-control"
              id="username"
              name="username"
              placeholder=""
              required />
            <label for="username">Username</label>
          </div>
        </div>
      </div>
      <div class="row mb-3 justify-content-center">
        <div class="col-4">
          <div class="form-floating">
            <input
              type="password"
              class="form-control"
              id="password"
              name="password"
              placeholder=""
              required
              minlength="8"
              maxlength="20"
              pattern="^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*\W)(?!.*(.)\1{2,}).{8,20}$"
              title="The password must be 8-20 characters long, contain uppercase and lowercase letters, numbers, special symbols, and avoid 3 consecutive identical characters." />
            <label for="password">Password</label>
          </div>
          <div
            class="invalid-feedback"
            id="password-error"
            style="display: none">
            The password must be 8-20 characters long, contain uppercase and lowercase letters, numbers, special symbols, and avoid 3 consecutive identical characters.
          </div>
        </div>
      </div>
      <div class="row mb-3 justify-content-center">
        <div class="col-4">
          <div class="form-floating">
            <input
              type="password"
              class="form-control"
              id="confirm_password"
              name="confirm_password"
              placeholder=""
              required />
            <label for="confirm_password">Confirm Password</label>
          </div>
          <div
            class="invalid-feedback"
            id="confirm-error"
            style="display: none">
            Passwords do not match
          </div>
        </div>
      </div>
      <div class="row mb-4 justify-content-center">
        <div class="col-4">
          <div class="form-floating">
            <input
              type="email"
              class="form-control"
              id="email"
              name="email"
              placeholder=""
              required/>
            <label for="email">Email</label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-4 mx-auto d-flex justify-content-center">
          <div class="d-grid col-4 me-3">
            <a class="btn btn-danger" href="{{ url_for('index') }}">Cancel</a>
          </div>
          <div class="d-grid col-4">
            <button type="submit" class="btn btn-primary">Register</button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <script>
    const password = document.getElementById("password");
    const confirmPassword = document.getElementById("confirm_password");
    const passwordError = document.getElementById("password-error");
    const confirmError = document.getElementById("confirm-error");

    password.addEventListener("input", function () {
      const isValid = this.checkValidity();
      if (isValid) {
        this.classList.remove("is-invalid");
        this.classList.add("is-valid");
        passwordError.style.display = "none";
      } else {
        this.classList.remove("is-valid");
        this.classList.add("is-invalid");
        passwordError.style.display = "block";
      }
      checkPasswordMatch();
    });

    confirmPassword.addEventListener("input", checkPasswordMatch);

    function checkPasswordMatch() {
      if (confirmPassword.value === "") {
        confirmPassword.classList.remove("is-valid", "is-invalid");
        confirmError.style.display = "none";
        return;
      }

      if (password.value === confirmPassword.value) {
        confirmPassword.classList.remove("is-invalid");
        confirmPassword.classList.add("is-valid");
        confirmError.style.display = "none";
      } else {
        confirmPassword.classList.remove("is-valid");
        confirmPassword.classList.add("is-invalid");
        confirmError.style.display = "block";
      }
    }

    document.querySelector("form").addEventListener("submit", function (e) {
      const isPasswordValid = password.checkValidity();
      const isPasswordMatch = password.value === confirmPassword.value;

      if (!isPasswordValid || !isPasswordMatch) {
        e.preventDefault();
        alert("Please make sure all fields meet the requirements.");
        return false;
      }
    });

    // Example: AJAX call to check if account exists (for Small_Account option)
    const usernameInput = document.getElementById("username");
    let usernameFeedback = document.createElement("div");
    usernameFeedback.className = "invalid-feedback";
    usernameFeedback.id = "username-feedback";
    usernameFeedback.style.display = "none";
    usernameInput.parentNode.appendChild(usernameFeedback);

    usernameInput.addEventListener("input", function () {
        const value = usernameInput.value.trim();
        usernameInput.classList.remove("is-valid", "is-invalid");
        if (!value) {
        usernameFeedback.style.display = "none";
        checkAllValid();
        return;
        }
        const currentValue = value;
        fetch(window.location.href, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ option: "Account", type: "get_account", value: value })
        })
        .then(response => {
            if (usernameInput.value.trim() !== currentValue) return;
            usernameInput.classList.remove("is-valid", "is-invalid");
            if (response.status === 200) {
            usernameInput.classList.add("is-invalid");
            usernameFeedback.textContent = "The account already exists, please change it.";
            usernameFeedback.style.display = "block";
            } else if (response.status === 404) {
            usernameInput.classList.add("is-valid");
            usernameFeedback.textContent = "";
            usernameFeedback.style.display = "none";
            }
            checkAllValid();
        })
        .catch(() => {
            usernameInput.classList.remove("is-valid", "is-invalid");
            usernameInput.classList.add("is-invalid");
            usernameFeedback.textContent = "An error occurred while checking the account.";
            usernameFeedback.style.display = "block";
            checkAllValid();
        });
    });

    // Example: AJAX call to check if email exists
    const emailInput = document.getElementById("email");
    let emailFeedback = document.createElement("div");
    emailFeedback.className = "invalid-feedback";
    emailFeedback.id = "email-feedback";
    emailFeedback.style.display = "none";
    emailInput.parentNode.appendChild(emailFeedback);

    emailInput.addEventListener("input", function () {
    const value = emailInput.value.trim();
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    emailInput.classList.remove("is-valid", "is-invalid");
    if (!value) {
        emailFeedback.style.display = "none";
        checkAllValid();
        return;
    }
    if (!emailPattern.test(value)) {
        emailInput.classList.add("is-invalid");
        emailFeedback.textContent = "Please enter a valid email address, for example: sophie@example.com";
        emailFeedback.style.display = "block";
        checkAllValid();
        return;
    }
    const currentValue = value;
    fetch(window.location.href, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ option: "Email", type: "get_email", value: value })
    })
    .then(response => {
        if (emailInput.value.trim() !== currentValue) return;
        emailInput.classList.remove("is-valid", "is-invalid");
        if (response.status === 200) {
            emailInput.classList.add("is-invalid");
            emailFeedback.textContent = "Email already exists, please change it.";
            emailFeedback.style.display = "block";
        } else if (response.status === 404) {
            emailInput.classList.add("is-valid");
            emailFeedback.textContent = "";
            emailFeedback.style.display = "none";
        }
        checkAllValid();
    })
    .catch(() => {
        if (emailInput.value.trim() !== currentValue) return;
        emailInput.classList.remove("is-valid", "is-invalid");
        emailInput.classList.add("is-invalid");
        emailFeedback.textContent = "An error occurred while checking email.";
        emailFeedback.style.display = "block";
        checkAllValid();
    });
});

    const registerBtn = document.querySelector('button[type="submit"]');

    // 檢查所有欄位是否有效
    function checkAllValid() {
        // 檢查 username
        const usernameValid = usernameInput.classList.contains("is-valid");
        // 檢查 password
        const passwordValid = password.classList.contains("is-valid");
        // 檢查 confirm password
        const confirmValid = confirmPassword.classList.contains("is-valid");
        // 檢查 email
        const emailValid = emailInput.classList.contains("is-valid");

        console.log(
        "username:", usernameInput.classList.contains("is-valid"),
        "password:", password.classList.contains("is-valid"),
        "confirm:", confirmPassword.classList.contains("is-valid"),
        "email:", emailInput.classList.contains("is-valid")
        );

        // 只要有一個不符合就 disable
        if (usernameValid && passwordValid && confirmValid && emailValid) {
            registerBtn.disabled = false;
        } else {
            registerBtn.disabled = true;
        }
    }

    // 監聽所有欄位的 input/change 事件
    usernameInput.addEventListener("input", checkAllValid);
    password.addEventListener("input", checkAllValid);
    confirmPassword.addEventListener("input", checkAllValid);
    emailInput.addEventListener("input", checkAllValid);

    // 預設一開始就 disable
    registerBtn.disabled = true;
  </script>

  <br>

</section>
{% endblock %}

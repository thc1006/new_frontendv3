{% extends "base.html" %}

{% block style %}
<!-- css -->
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/AI_config.css')}}">
{% endblock %}

{% block nav %}
<ul class="navbar-nav">
    <li class="nav-item">
        <a class="nav-link" href="{{url_for('overview', PID=PID)}}">Overview</a>
    </li>
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Configuration
        </a>
        <ul class="dropdown-menu">
            <li><a class="nav-link" href="{{ url_for('gNB_config', PID=PID) }}">gNodeB</a></li>
            <li><a class="nav-link active" aria-current="page" href="{{ url_for('AI_config', PID=PID) }}">AI Models</a></li>
            <li><a class="nav-link" href="{{ url_for('evaluation', PID=PID) }}">Evaluation</a></li>
        </ul>
    </li>
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Performance
        </a>
        <ul class="dropdown-menu">
            <li><a class="nav-link" href="{{ url_for('performanceNES', PID=PID) }}">NES</a></li>
            <li><a class="nav-link" href="{{ url_for('performanceMRO', PID=PID) }}">MRO</a></li>
        </ul>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{{url_for('edit', PID=PID)}}">Edit</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{{url_for('projects')}}">Projects List</a>
    </li>
</ul>
{% endblock %}

{% block content %}
<section>
    <div class="container" id="gridContainer">
        <div class="row">
            <div class="col-3">
                <div class="col rounded p-3" id="sidebarContainer">
                    <div class="row mb-3 justify-content-center">
                        <div class="d-grid col-11 align-items-center">
                            <button type="button" class="btn btn-outline-primary p-3" id="modalToggle" data-bs-toggle="modal" data-bs-target="#autoApplyModal">
                                Auto Apply Off
                            </button>
                        </div>
                    </div>


                    <!-- Create and Delete Buttons -->
                    <div class="row mb-3 justify-content-center">
                        <div class="d-flex col-12">
                            <button type="button" class="btn btn-success me-2 w-50" id="CreateModelButton" data-bs-toggle="modal" data-bs-target="#createModelModal">
                                Create Model
                            </button>
                            <button type="button" class="btn btn-danger w-50" id="DeleteModelButton" data-bs-toggle="modal" data-bs-target="#deleteModelModal">
                                Delete Model
                            </button>
                        </div>
                    </div>


                    <ul class="list-group" id="modelList">
                        {% if not tmp_ai_data %}
                        <p>No AI models available yet.</p>
                        {% else %}
                        {% for model in tmp_ai_data %}
                        <li class="list-group-item d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center justify-content-start w-100">
                                <button type="button" class="btn btn-secondary me-2" id="inputdatabtn{{ model }}" data-bs-toggle="modal" data-bs-target="#inputdatabtnModal{{ model }}">Input</button>
                                <label class="form-check-label me-auto" for="switch{{ model }}">{{ model }}</label>
                                <div class="form-switch ms-auto me-0">
                                    <input class="form-check-input" type="checkbox" id="switch{{ model }}">
                                </div>
                                <button type="button" class="btn btn-primary me-0" id="retrain{{ model }}" data-bs-toggle="modal" data-bs-target="#retrainModal">Retrain</button>
                            </div>
                        </li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>
            <div class="col-9 rounded" id="responseContainer">
                <div class="row p-3">
                    <div class="row mb-3">
                        <div class="col" id="title">AI INFERENCE</div>
                    </div>
                    <div class="row" id="inference"></div>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- auto apply Modal -->
<div class="modal fade" id="autoApplyModal" tabindex="-1" aria-hidden="true" style="color: #000000;">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background-color: #D9D9D9;"> <!-- rgba(221, 170, 204, 1.0) -->
            <!-- Header -->
            <div class="modal-header">
                <h1 class="modal-title fs-4" id="modalLabel">
                    <div class="form-check form-switch" style="display: contents">
                        <label class="form-check-label no-select" for="autoApplyToggle">Auto Apply</label>
                        <input class="form-check-input" type="checkbox" role="switch" id="autoApplyToggle" style="float: right; margin-left: .5em">
                    </div>
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Body -->
            <div class="modal-body">
                {% if not tmp_ai_data %}
                <div class="row modalRow">
                    <div class="col"><p>No AI models available yet.</p></div>
                </div>
                {% else %}
                    {% for model in tmp_ai_data %}
                    <div class="row modalRow">
                        <div class="col-3">AI Model {{ model }}</div>
                        <div class="col-6">
                            <input type="range" class="form-range" id="proportionSlider{{ model }}" value="0">
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control" id="proportionInput{{ model }}" max="100" min="0" value="0">
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
                <div class="row modalRow justify-content-center">
                    <div class="col-3">
                        <button type="button" class="btn btn-primary fullWidth" id='btnAutoSave' data-bs-dismiss="modal">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Retrain Modal -->
<div class="modal fade" id="retrainModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" style="color: #225533;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-dialog" style="width: 500px;">
            <div class="modal-content" style="background-color: #DDAACC;">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="retrainLabel"></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 class="text-center">Training Config</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Central exchange round</span>
                        <input class="form-control w-auto" value="{{training_config.round}}" id="round"/>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Local training epoch</span>
                        <input class="form-control w-auto" value="{{training_config.epochs}}" id="epoch"/>
                    </div>
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-primary" id="config">Config</button>
                    </div>
                    <h5 class="text-center">Query Model Training Performance</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Recall</span>
                        <input readonly class="form-control w-auto" value="{{query_Model_Training_Performance.recall}}"/>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Specificity</span>
                        <input readonly class="form-control w-auto" value="{{query_Model_Training_Performance.specificity}}"/>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Precision</span>
                        <input readonly class="form-control w-auto" value="{{query_Model_Training_Performance.precision}}"/>
                    </div>
                    <h5 class="text-center">Request Model Deployment</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Client ID</span>
                        <input class="form-control w-auto" id="clientID"/>
                    </div>
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-primary" id="deployment">Deployment</button>
                    </div>
                    <h5 class="text-center">Request Model Retrain</h5>
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-primary" id="retrain">Retrain</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Create Model Modal -->
<div class="modal fade" id="createModelModal" tabindex="-1" aria-labelledby="createModelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #434548;">
            <div class="modal-header">
                <h5 class="modal-title" id="createModelModalLabel">Create AI Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newModelName" class="form-label">Enter Model Name:</label>
                    <input type="text" class="form-control" id="newModelName" placeholder="Model Name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewModelButton">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Model Modal -->
<div class="modal fade" id="deleteModelModal" tabindex="-1" aria-labelledby="deleteModelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #434548;">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModelModalLabel">Delete AI Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="deleteModelName" class="form-label">Select Model to Delete:</label>
                    <select class="form-select" id="deleteModelName">
                        <option selected disabled>Choose a model</option>
                        {% for model in tmp_ai_data %}
                        <option value="{{ model }}">{{ model }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteModelButton">Delete</button>
            </div>
        </div>
    </div>
</div>


<!-- inputdatabtn Modal -->
{% for model in tmp_ai_data %}
<div class="modal fade" id="inputdatabtnModal{{ model }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" style="color: #683809;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-dialog" style="width: 500px;">
            <div class="modal-content" style="background-color: #89daef;">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="inputdatabtnLabel{{ model }}">Model {{ model }}</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                

                <div class="modal-body">
                    <div style="padding-left: 2px; padding-right: 2px;">
                        <h5 class="text-center">Upload Model and Set Interference Period</h5>
                        
                        <!-- File upload for .pth -->
                        <div class="form-group mb-3">
                            <label for="pthUpload{{ model }}" class="form-label">Upload Model (.pth):</label>
                            <input class="form-control" type="file" id="pthUpload{{ model }}" accept=".pth">
                        </div>
                
                        <!-- Interference Period Input -->
                        <div class="form-group mb-3">
                            <label for="interferencePeriod{{ model }}" class="form-label">Interference Period (ms):</label>
                            <input class="form-control" type="number" id="interferencePeriod{{ model }}" min="1" placeholder="Enter period in milliseconds">
                        </div>
                    </div>
                </div>


                <div class="modal-body">
                    <h5 class="text-center">Select Training Parameters</h5>

                     <!-- Dropdown menu for selecting parameters -->
                     <div class="form-group mb-3">
                        <label for="parameterSelect{{ model }}" class="form-label">Choose parameters :</label>
                        <select class="form-select" id="parameterSelect{{ model }}" aria-label="Select a parameter">
                            <option selected disabled>Select a parameter</option>
                            <!-- Loop through keys_set to create options -->
                            {% for key in wisdon_ue_data_set %}
                                <option value="{{ key }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Display selected parameters -->
                    <div class="mb-3">
                        <h6>Selected Parameters :</h6>
                        <ul id="selectedParameters{{ model }}" class="list-group">
                            <!-- Selected parameters will appear here -->
                        </ul>
                    </div>

                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-success done-button" data-model="{{ model }}" id="doneButton{{ model }}">Done</button>
                    </div>
                    

                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- inputdatabtn js -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const models = {{ tmp_ai_data | safe }}; // 獲取 models 陣列
        let selectedParamsMap = {}; // 儲存每個 model 的選擇參數
    
        models.forEach(function (model) {
            console.log("Processing model:", model); // Debug line
    
            selectedParamsMap[model] = new Set();
    
            const parameterSelect = document.getElementById(`parameterSelect${model}`);
            const selectedParameters = document.getElementById(`selectedParameters${model}`);
            const doneButton = document.getElementById(`doneButton${model}`);
            const inputButton = document.getElementById(`inputdatabtn${model}`);
            const modalElement = document.getElementById(`inputdatabtnModal${model}`);
            const modal = new bootstrap.Modal(modalElement);
    
            if (!parameterSelect || !selectedParameters || !doneButton || !inputButton) {
                console.error(`Element missing for model ${model}`);
                return; // Skip this iteration if any element is missing
            }
    
            // 監聽參數選擇變更
            parameterSelect.addEventListener('change', function () {
                const selectedValue = parameterSelect.value;
                if (selectedValue && !selectedParamsMap[model].has(selectedValue)) {
                    selectedParamsMap[model].add(selectedValue);
                    addParameter(selectedValue, selectedParameters, model);
                    console.log(`Added parameter: ${selectedValue} to model: ${model}`); // Debug line
                }
            });
    
            // 監聽 Done 按鈕
            doneButton.addEventListener('click', function () {
                // 改變 input 按鈕顏色
                inputButton.classList.remove('btn-secondary');
                inputButton.classList.add('btn-success');
                
                // 關閉 modal
                modal.hide();
                

                // 清空選擇的參數列表
                selectedParameters.innerHTML = '';
                // 準備選擇的參數數據以便回傳
                const selectedParams = Array.from(selectedParamsMap[model]);
                selectedParams.forEach(param => {
                    addParameter(param, selectedParameters, model);
                });

                const interferencePeriod = document.getElementById(`interferencePeriod${model}`).value;

                let data = {
                    type: 'selected_parameters',
                    model_name: model,
                    parameters: selectedParams,
                    interference_period: interferencePeriod
                };
                
                console.log(data); // 確認要回傳的數據格式

                // 發送 AJAX 請求，將選取的參數和模型名稱發送至伺服器
                $.ajax({
                    url: window.location.href,
                    data: JSON.stringify(data),
                    type: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function(response) {
                        console.log("Server response:", response);
                    }
                });
            });
    
            // 新增參數到顯示列表中
            function addParameter(parameter, listContainer, model) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = parameter;
    
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-danger';
                removeBtn.textContent = '✕';
                removeBtn.addEventListener('click', function () {
                    removeParameter(parameter, li, model);
                });
    
                li.appendChild(removeBtn);
                listContainer.appendChild(li);
            }
    
            // 移除參數
            function removeParameter(parameter, listItem, model) {
                selectedParamsMap[model].delete(parameter);
                selectedParameters.removeChild(listItem);
            }
        });
    });
</script>



<!-- createbtn js -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const saveButton = document.getElementById('saveNewModelButton');
    const inputField = document.getElementById('newModelName');

    saveButton.addEventListener('click', function () {
        const modelName = inputField.value.trim();

        if (!modelName) {
            alert("Please enter a valid model name.");
            return;
        }

        // 準備數據
        const data = {
            type: 'create_model',
            model_name: modelName
        };

        console.log("Creating model:", data); // Debug

        // AJAX 發送資料到伺服器
        $.ajax({
            url: window.location.href, // 使用當前頁面的 URL
            data: JSON.stringify(data),
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            success: function (response) {
                console.log("Server response:", response);
                // 可根據需求更新 UI 或顯示成功消息
                alert("Model created successfully!");
                location.reload(); // 直接刷新頁面
            },
            error: function (xhr, status, error) {
                console.error("Error creating model:", error);
                alert("Failed to create model. Please try again.");
            }
        });

        // 關閉 modal 並清空輸入框
        const modal = bootstrap.Modal.getInstance(document.getElementById('createModelModal'));
        modal.hide();
        inputField.value = '';
    });
});
</script>

<!-- deletebtn js -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const deleteButton = document.getElementById('confirmDeleteModelButton');
    const deleteModelSelect = document.getElementById('deleteModelName');

    deleteButton.addEventListener('click', function () {
        const selectedModel = deleteModelSelect.value;

        if (!selectedModel) {
            alert("Please select a model to delete.");
            return;
        }

        // 準備刪除模型的數據
        const data = {
            type: 'delete_model',
            model_name: selectedModel
        };

        console.log("Deleting model:", data); // Debug

        // AJAX 請求刪除模型
        $.ajax({
            url: window.location.href, // 使用當前頁面的 URL
            data: JSON.stringify(data),
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            success: function (response) {
                console.log("Server response:", response);
                alert(`Model "${selectedModel}" deleted successfully!`);
                location.reload(); // 直接刷新頁面
            },
            error: function (xhr, status, error) {
                console.error("Error deleting model:", error);
                alert(`Failed to delete model "${selectedModel}". Please try again.`);
            }
        });

        // 關閉 modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModelModal'));
        modal.hide();
    });
});
</script>


<script src="{{url_for('static', filename='js/AI_config.js')}}" type="module"></script>
<script>
    const tmp_ai_data = {{ tmp_ai_data|tojson }};
    const last_AI_config = {{ last_AI_config|tojson }};
    const training_config = {{ training_config|tojson }};
    const query_Model_Training_Performance = {{ query_Model_Training_Performance|tojson }};
</script>
{% endblock %}
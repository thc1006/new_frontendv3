# CD Pipeline - 合併到 main 後自動佈署
name: CD

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'k8s/**'
      - '.github/workflows/cd.yml'
  # 允許手動觸發
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  REGISTRY: localhost  # 本地 podman registry
  IMAGE_NAME: wisdon-frontend
  K8S_NAMESPACE: wisdon-frontend

jobs:
  build:
    name: Build & Verify Image
    runs-on: self-hosted
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      full_image: ${{ steps.meta.outputs.full_image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image metadata
        id: meta
        run: |
          VERSION=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="${VERSION}-${TIMESTAMP}"
          echo "version=${TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}" >> $GITHUB_OUTPUT

      - name: Build container image
        working-directory: frontend
        run: |
          podman build \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --label "git.commit=${{ github.sha }}" \
            --label "git.branch=${{ github.ref_name }}" \
            .

      - name: Verify image built
        run: |
          # 使用 podman image exists 精確驗證 image 是否存在
          if podman image exists ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest; then
            echo "✅ Image built successfully: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            echo "   (Also tagged as: ${{ steps.meta.outputs.version }})"
            podman images | grep ${{ env.IMAGE_NAME }} | head -3
          else
            echo "❌ Image not found: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            exit 1
          fi

  deploy:
    name: Deploy to K8s
    runs-on: self-hosted
    needs: build
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restart K8s deployment
        run: |
          # K8s 使用 imagePullPolicy: Never + :latest tag
          # 使用 rollout restart 強制重新拉取本地 :latest image
          kubectl rollout restart deployment/frontend \
            -n ${{ env.K8S_NAMESPACE }}

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/frontend \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=300s

      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment frontend -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=frontend
          echo ""
          echo "=== Service Status ==="
          kubectl get svc frontend-service -n ${{ env.K8S_NAMESPACE }}

      - name: Health check
        run: |
          # 等待服務就緒後進行健康檢查
          sleep 10
          FRONTEND_URL="http://localhost:80"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_URL || echo "000")
          if [[ "$HTTP_STATUS" == "200" || "$HTTP_STATUS" == "301" || "$HTTP_STATUS" == "302" ]]; then
            echo "✅ Health check passed! (HTTP $HTTP_STATUS)"
          else
            echo "⚠️ Health check returned HTTP $HTTP_STATUS"
          fi

  notify:
    name: Notify Deployment
    runs-on: self-hosted
    needs: [build, deploy]
    if: always()
    steps:
      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ needs.build.outputs.full_image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Status | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

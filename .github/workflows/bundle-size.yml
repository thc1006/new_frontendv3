name: Bundle Size Analysis

on:
  pull_request:
    branches: [main]
    paths:
      - 'new/new-frontend/**'
      - '!new/new-frontend/tests/**'
      - '!new/new-frontend/**/*.md'

permissions:
  pull-requests: write
  contents: read

jobs:
  analyze:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./new/new-frontend

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: new/new-frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build PR branch
        run: npm run build
        env:
          NODE_ENV: production

      - name: Calculate PR bundle sizes
        id: pr_size
        run: |
          # Total size
          TOTAL=$(du -sb .output/public | cut -f1)
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # JS size
          JS_SIZE=$(find .output/public -name "*.js" -exec du -cb {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
          echo "js=$JS_SIZE" >> $GITHUB_OUTPUT

          # CSS size
          CSS_SIZE=$(find .output/public -name "*.css" -exec du -cb {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
          echo "css=$CSS_SIZE" >> $GITHUB_OUTPUT

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          clean: false

      - name: Clean PR build output
        run: rm -rf .output .nuxt

      - name: Install base dependencies
        run: npm ci

      - name: Build base branch
        run: npm run build
        env:
          NODE_ENV: production
        continue-on-error: true

      - name: Calculate base bundle sizes
        id: base_size
        run: |
          if [ -d ".output/public" ]; then
            TOTAL=$(du -sb .output/public | cut -f1)
            JS_SIZE=$(find .output/public -name "*.js" -exec du -cb {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
            CSS_SIZE=$(find .output/public -name "*.css" -exec du -cb {} + 2>/dev/null | tail -1 | cut -f1 || echo "0")
          else
            TOTAL=0
            JS_SIZE=0
            CSS_SIZE=0
          fi
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "js=$JS_SIZE" >> $GITHUB_OUTPUT
          echo "css=$CSS_SIZE" >> $GITHUB_OUTPUT

      - name: Compare and report
        uses: actions/github-script@v7
        with:
          script: |
            const prTotal = parseInt('${{ steps.pr_size.outputs.total }}') || 0;
            const baseTotal = parseInt('${{ steps.base_size.outputs.total }}') || 0;
            const prJs = parseInt('${{ steps.pr_size.outputs.js }}') || 0;
            const baseJs = parseInt('${{ steps.base_size.outputs.js }}') || 0;
            const prCss = parseInt('${{ steps.pr_size.outputs.css }}') || 0;
            const baseCss = parseInt('${{ steps.base_size.outputs.css }}') || 0;

            const formatBytes = (bytes) => {
              if (bytes === 0) return '0 B';
              const k = 1024;
              const sizes = ['B', 'KB', 'MB'];
              const i = Math.floor(Math.log(bytes) / Math.log(k));
              return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            const formatDiff = (pr, base) => {
              if (base === 0) return 'N/A';
              const diff = pr - base;
              const pct = ((diff / base) * 100).toFixed(1);
              const emoji = diff > 0 ? 'ðŸ“ˆ' : diff < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
              const sign = diff > 0 ? '+' : '';
              return `${emoji} ${sign}${formatBytes(diff)} (${sign}${pct}%)`;
            };

            const body = `## ðŸ“¦ Bundle Size Report

            | Asset | Base | PR | Change |
            |-------|------|-----|--------|
            | **Total** | ${formatBytes(baseTotal)} | ${formatBytes(prTotal)} | ${formatDiff(prTotal, baseTotal)} |
            | JavaScript | ${formatBytes(baseJs)} | ${formatBytes(prJs)} | ${formatDiff(prJs, baseJs)} |
            | CSS | ${formatBytes(baseCss)} | ${formatBytes(prCss)} | ${formatDiff(prCss, baseCss)} |

            ${prTotal - baseTotal > 100000 ? 'âš ï¸ **Warning:** Bundle size increased by more than 100KB' : ''}
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('Bundle Size Report'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

            // Fail if bundle size increased significantly (> 500KB)
            // Skip check if base build failed (baseTotal = 0)
            if (baseTotal > 0 && prTotal - baseTotal > 500000) {
              core.setFailed('Bundle size increased by more than 500KB');
            } else if (baseTotal === 0) {
              core.info('Base build failed or is new - skipping size comparison');
            }
